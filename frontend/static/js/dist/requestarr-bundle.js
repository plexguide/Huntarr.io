(function(){"use strict";function B(){try{const u="huntarr-smarthunt-page-";for(let e=1;e<=5;e++)localStorage.removeItem(`${u}${e}`)}catch{}}class R{constructor(e){this.carouselId=e.carouselId,this.core=e.core||null,this.getMovieInstance=e.getMovieInstance||(()=>""),this.getTVInstance=e.getTVInstance||(()=>""),this.currentPage=0,this.hasMore=!0,this.isLoading=!1,this._scrollHandler=null}load(){this.currentPage=0,this.hasMore=!0;const e=document.getElementById(this.carouselId);e&&(e.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading Smart Hunt...</p></div>'),this._loadNextPage(!1),this._attachInfiniteScroll()}reload(){this.load()}destroy(){if(this._scrollHandler){const e=document.getElementById(this.carouselId);e&&e.removeEventListener("scroll",this._scrollHandler),this._scrollHandler=null}}async _loadNextPage(e){if(this.isLoading||!this.hasMore)return;this.isLoading=!0;const t=this.currentPage+1;try{const s=await this._fetchPage(t);this._render(s,e),this.currentPage=t,this.hasMore=t<5&&s.length>0}catch(s){if(console.error("[SmartHunt] Error loading page",t,s),!e){const a=document.getElementById(this.carouselId);a&&(a.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load Smart Hunt results</p>')}}finally{this.isLoading=!1}}async _fetchPage(e){const t=this.getMovieInstance(),s=this.getTVInstance();let a="",n="";if(t&&t.includes(":")){const l=t.indexOf(":");a=t.substring(0,l),n=t.substring(l+1)}else a="radarr",n=t||"";const i=new URLSearchParams({page:String(e),movie_app_type:a,movie_instance_name:n,tv_instance_name:s||""}),r=await fetch(`./api/requestarr/smarthunt?${i.toString()}`);if(!r.ok)throw new Error(`HTTP ${r.status}`);return(await r.json()).results||[]}_render(e,t){const s=document.getElementById(this.carouselId);if(s){if(t||(s.innerHTML=""),e.length===0&&!t){s.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No Smart Hunt results available</p>';return}e.forEach(a=>{const n=a.media_type==="movie"?this.getMovieInstance():this.getTVInstance(),i=this._createCard(a,n);i&&s.appendChild(i)})}}_createCard(e,t){return this.core&&this.core.content&&typeof this.core.content.createMediaCard=="function"?this.core.content.createMediaCard(e,t):window.RequestarrDiscover&&window.RequestarrDiscover.content&&typeof window.RequestarrDiscover.content.createMediaCard=="function"?window.RequestarrDiscover.content.createMediaCard(e,t):null}_attachInfiniteScroll(){const e=document.getElementById(this.carouselId);e&&(this._scrollHandler&&e.removeEventListener("scroll",this._scrollHandler),this._scrollHandler=()=>{if(this.isLoading||!this.hasMore)return;e.scrollWidth-e.scrollLeft-e.clientWidth<300&&this._loadNextPage(!0)},e.addEventListener("scroll",this._scrollHandler,{passive:!0}))}}window.SmartHunt=R,window.invalidateSmartHuntCache=B;class x{constructor(e){this.core=e,this.moviesPage=1,this.moviesHasMore=!0,this.isLoadingMovies=!1,this.moviesObserver=null,this.tvPage=1,this.tvHasMore=!0,this.isLoadingTV=!1,this.tvObserver=null,this.moviesRequestToken=0,this.tvRequestToken=0,this.activeMovieInstance=null,this.activeTVInstance=null,this.selectedMovieInstance=null,this.selectedTVInstance=null,this._serverDefaultsLoaded=!1,this.hiddenMediaSet=new Set,document.addEventListener("huntarr:instances-changed",()=>{this.refreshInstanceSelectors()})}async setupInstanceSelectors(){await this._loadServerDefaults(),await this.loadMovieInstances(),await this.loadTVInstances()}async refreshInstanceSelectors(){this._serverDefaultsLoaded=!1,await this._loadServerDefaults(),await Promise.all([this._populateDiscoverMovieInstances(),this._populateDiscoverTVInstances()]),await this.loadMovieInstances(),await this.loadTVInstances()}async _loadServerDefaults(){if(!this._serverDefaultsLoaded){try{const t=await(await fetch("./api/requestarr/settings/default-instances")).json();t.success&&t.defaults&&(this.selectedMovieInstance=t.defaults.movie_instance||null,this.selectedTVInstance=t.defaults.tv_instance||null,console.log("[RequestarrContent] Loaded server defaults:",t.defaults))}catch(e){console.warn("[RequestarrContent] Could not load server defaults:",e)}this._serverDefaultsLoaded=!0}}_saveServerDefaults(){return fetch("./api/requestarr/settings/default-instances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({movie_instance:this.selectedMovieInstance||"",tv_instance:this.selectedTVInstance||""})}).catch(e=>console.warn("[RequestarrContent] Failed to save server defaults:",e))}async _setMovieInstance(e){this.selectedMovieInstance=e,this._syncAllMovieSelectors(),await this._saveServerDefaults(),this._discoverSmartHunt&&this._discoverSmartHunt.reload()}async _setTVInstance(e){this.selectedTVInstance=e,this._syncAllTVSelectors(),await this._saveServerDefaults(),this._discoverSmartHunt&&this._discoverSmartHunt.reload()}_syncAllMovieSelectors(){["movies-instance-select","discover-movie-instance-select","home-movie-instance-select"].forEach(t=>{const s=document.getElementById(t);s&&s.value!==this.selectedMovieInstance&&(s.value=this.selectedMovieInstance)}),window.HomeRequestarr&&(window.HomeRequestarr.defaultMovieInstance=this.selectedMovieInstance)}_syncAllTVSelectors(){["tv-instance-select","discover-tv-instance-select","home-tv-instance-select"].forEach(t=>{const s=document.getElementById(t);s&&s.value!==this.selectedTVInstance&&(s.value=this.selectedTVInstance)}),window.HomeRequestarr&&(window.HomeRequestarr.defaultTVInstance=this.selectedTVInstance)}async setupDiscoverInstances(){await this._loadServerDefaults(),await Promise.all([this._populateDiscoverMovieInstances(),this._populateDiscoverTVInstances()])}async _populateDiscoverMovieInstances(){const e=document.getElementById("discover-movie-instance-select");if(e)try{const t=Date.now(),[s,a]=await Promise.all([fetch(`./api/requestarr/instances/movie_hunt?t=${t}`,{cache:"no-store"}),fetch(`./api/requestarr/instances/radarr?t=${t}`,{cache:"no-store"})]),n=await s.json(),i=await a.json(),r=[...(n.instances||[]).map(l=>({name:String(l.name).trim(),_appType:"movie_hunt",_label:`Movie Hunt – ${String(l.name).trim()}`})),...(i.instances||[]).map(l=>({name:String(l.name).trim(),_appType:"radarr",_label:`Radarr – ${String(l.name).trim()}`}))],o=this.selectedMovieInstance||e.value||"";if(e.innerHTML="",r.length===0){e.innerHTML='<option value="">No movie instances</option>';return}r.forEach(l=>{const d=S(l._appType,l.name),c=document.createElement("option");c.value=d,c.textContent=l._label,o&&(d===o||l.name===o)&&(c.selected=!0),e.appendChild(c)}),e.value&&(this.selectedMovieInstance=e.value),e._discoverChangeWired||(e._discoverChangeWired=!0,e.addEventListener("change",async()=>{await this._setMovieInstance(e.value),this.reloadDiscoverMovies()}))}catch(t){console.error("[RequestarrContent] Error loading discover movie instances:",t)}}async _populateDiscoverTVInstances(){const e=document.getElementById("discover-tv-instance-select");if(e)try{const a=((await(await fetch(`./api/requestarr/instances/sonarr?t=${Date.now()}`,{cache:"no-store"})).json()).instances||[]).map(i=>({name:String(i.name).trim()})),n=this.selectedTVInstance||e.value||"";if(e.innerHTML="",a.length===0){e.innerHTML='<option value="">No TV instances</option>';return}a.forEach(i=>{const r=document.createElement("option");r.value=i.name,r.textContent=`Sonarr – ${i.name}`,n&&i.name===n&&(r.selected=!0),e.appendChild(r)}),e.value&&(this.selectedTVInstance=e.value),e._discoverChangeWired||(e._discoverChangeWired=!0,e.addEventListener("change",async()=>{await this._setTVInstance(e.value),this.reloadDiscoverTV()}))}catch(t){console.error("[RequestarrContent] Error loading discover TV instances:",t)}}async reloadDiscoverMovies(){const e=document.getElementById("popular-movies-carousel");if(e){e.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading movies...</p></div>';try{const t=b(this.selectedMovieInstance);let s="./api/requestarr/discover/movies?page=1";t.name&&(s+=`&app_type=${t.appType}&instance_name=${encodeURIComponent(t.name)}`);const n=await(await fetch(s)).json(),i=n.results&&n.results.length>0?n.results:[];this.renderPopularMoviesResults(e,i)}catch(t){console.error("[RequestarrContent] Error reloading discover movies:",t)}await this.loadTrending()}}async reloadDiscoverTV(){const e=document.getElementById("popular-tv-carousel");if(e){e.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading TV shows...</p></div>';try{let t="./api/requestarr/discover/tv?page=1";this.selectedTVInstance&&(t+=`&app_type=sonarr&instance_name=${encodeURIComponent(this.selectedTVInstance)}`);const a=await(await fetch(t)).json(),n=a.results&&a.results.length>0?a.results:[];this.renderPopularTVResults(e,n)}catch(t){console.error("[RequestarrContent] Error reloading discover TV:",t)}await this.loadTrending()}}async loadMovieInstances(){const e=document.getElementById("movies-instance-select");if(e){if(this._loadingMovieInstances){console.log("[RequestarrContent] loadMovieInstances already in progress, skipping");return}this._loadingMovieInstances=!0,e.innerHTML='<option value="">Loading instances...</option>';try{const t=Date.now(),[s,a]=await Promise.all([fetch(`./api/requestarr/instances/movie_hunt?t=${t}`,{cache:"no-store"}),fetch(`./api/requestarr/instances/radarr?t=${t}`,{cache:"no-store"})]),n=await s.json(),i=await a.json(),r=(n.instances||[]).map(d=>({...d,name:String(d.name).trim(),_appType:"movie_hunt",_label:`Movie Hunt – ${String(d.name).trim()}`})),o=(i.instances||[]).map(d=>({...d,name:String(d.name).trim(),_appType:"radarr",_label:`Radarr – ${String(d.name).trim()}`})),l=[...r,...o];if(console.log("[RequestarrContent] Movie Hunt instances:",r.length,"Radarr instances:",o.length),l.length>0){e.innerHTML="";const d=this.selectedMovieInstance,c=[],m=new Set;if(l.forEach(y=>{if(!y.name)return;const g=S(y._appType,y.name),f=g.toLowerCase();m.has(f)||(c.push({...y,_compoundValue:g}),m.add(f))}),console.log("[RequestarrContent] After deduplication:",c.length,"unique movie instances"),c.length===0){e.innerHTML='<option value="">No movie instances configured</option>',this.selectedMovieInstance=null;return}let h=0;c.forEach((y,g)=>{const f=document.createElement("option");f.value=y._compoundValue,f.textContent=y._label,d&&(y._compoundValue===d||y.name===d)?(f.selected=!0,h=g):!d&&g===0&&(f.selected=!0),e.appendChild(f)}),this._setMovieInstance(c[h]._compoundValue),console.log(`[RequestarrContent] Using movie instance: ${this.selectedMovieInstance}`);const v=e.cloneNode(!0);if(e.parentNode)e.parentNode.replaceChild(v,e);else{const y=document.getElementById("movies-instance-select");y&&y.parentNode&&y.parentNode.replaceChild(v,y)}v.addEventListener("change",async()=>{await this._setMovieInstance(v.value),console.log(`[RequestarrContent] Switched to movie instance: ${this.selectedMovieInstance}`);const y=document.getElementById("movies-grid");y&&(y.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading movies...</p></div>'),this.moviesObserver&&(this.moviesObserver.disconnect(),this.moviesObserver=null),this.moviesPage=1,this.moviesHasMore=!0,this.isLoadingMovies=!1,this.moviesRequestToken++,await new Promise(g=>setTimeout(g,50)),await this.loadMovies(),this.setupMoviesInfiniteScroll()})}else e.innerHTML='<option value="">No movie instances configured</option>',this.selectedMovieInstance=null}catch(t){console.error("[RequestarrContent] Error loading movie instances:",t),e.innerHTML='<option value="">Error loading instances</option>'}finally{this._loadingMovieInstances=!1}}}async loadTVInstances(){const e=document.getElementById("tv-instance-select");if(e){if(this._loadingTVInstances){console.log("[RequestarrContent] loadTVInstances already in progress, skipping");return}this._loadingTVInstances=!0,e.innerHTML='<option value="">Loading instances...</option>';try{const s=await(await fetch(`./api/requestarr/instances/sonarr?t=${Date.now()}`,{cache:"no-store"})).json();if(console.log("[RequestarrContent] Sonarr API returned",s.instances?.length||0,"instances"),s.instances&&s.instances.length>0){e.innerHTML="";const a=this.selectedTVInstance,n=[],i=new Set;if(s.instances.forEach(l=>{if(!l||!l.name)return;const d=String(l.name).trim();if(!d)return;const c=d.toLowerCase();i.has(c)||(n.push({...l,name:d}),i.add(c))}),console.log("[RequestarrContent] After deduplication:",n.length,"unique Sonarr instances"),n.length===0){e.innerHTML='<option value="">No Sonarr instances configured</option>',this.selectedTVInstance=null;return}let r=0;n.forEach((l,d)=>{const c=document.createElement("option");c.value=l.name,c.textContent=`Sonarr - ${l.name}`,a&&l.name===a?(c.selected=!0,r=d):!a&&d===0&&(c.selected=!0),e.appendChild(c)}),this._setTVInstance(n[r].name),console.log(`[RequestarrContent] Using TV instance: ${this.selectedTVInstance}`);const o=e.cloneNode(!0);if(e.parentNode)e.parentNode.replaceChild(o,e);else{const l=document.getElementById("tv-instance-select");l&&l.parentNode&&l.parentNode.replaceChild(o,l)}o.addEventListener("change",async()=>{await this._setTVInstance(o.value),console.log(`[RequestarrContent] Switched to TV instance: ${this.selectedTVInstance}`);const l=document.getElementById("tv-grid");l&&(l.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading TV shows...</p></div>'),this.tvObserver&&(this.tvObserver.disconnect(),this.tvObserver=null),this.tvPage=1,this.tvHasMore=!0,this.isLoadingTV=!1,this.tvRequestToken++,await new Promise(d=>setTimeout(d,50)),await this.loadTV(),this.setupTVInfiniteScroll()})}else e.innerHTML='<option value="">No Sonarr instances configured</option>',this.selectedTVInstance=null}catch(t){console.error("[RequestarrContent] Error loading TV instances:",t),e.innerHTML='<option value="">Error loading instances</option>'}finally{this._loadingTVInstances=!1}}}async loadDiscoverContent(){await this._loadServerDefaults(),await this.setupDiscoverInstances(),await this.loadHiddenMediaIds(),this._initDiscoverSmartHunt(),await Promise.all([this.loadTrending(),this.loadPopularMovies(),this.loadPopularTV()])}async _initDiscoverSmartHunt(){const e=document.getElementById("discover-smarthunt-section");if(e&&(e.style.display=""),!window.SmartHunt)return;const t=this;this._discoverSmartHunt&&this._discoverSmartHunt.destroy(),this._discoverSmartHunt=new window.SmartHunt({carouselId:"discover-smarthunt-carousel",core:{content:this},getMovieInstance:()=>t.selectedMovieInstance||"",getTVInstance:()=>t.selectedTVInstance||""}),this._discoverSmartHunt.load()}async loadHiddenMediaIds(){try{const t=await(await fetch("./api/requestarr/hidden-media?page=1&page_size=10000")).json(),s=Array.isArray(t.hidden_media)?t.hidden_media:Array.isArray(t.items)?t.items:[];this.hiddenMediaSet=new Set,s.forEach(a=>{const n=`${a.tmdb_id}:${a.media_type}:${a.app_type}:${a.instance_name}`;this.hiddenMediaSet.add(n)}),console.log("[RequestarrContent] Loaded",this.hiddenMediaSet.size,"hidden media items")}catch(e){console.error("[RequestarrContent] Error loading hidden media IDs:",e),this.hiddenMediaSet=new Set}}isMediaHidden(e,t,s,a){if(!this.hiddenMediaSet)return!1;const n=`${e}:${t}:${s}:${a}`;return this.hiddenMediaSet.has(n)}renderTrendingResults(e,t){e&&(t&&t.length>0?(e.innerHTML="",t.forEach(s=>{const a=s.media_type==="movie"?this.selectedMovieInstance||null:this.selectedTVInstance||null;let n,i;if(s.media_type==="movie"){const o=b(this.selectedMovieInstance);n=o.appType,i=o.name}else n="sonarr",i=this.selectedTVInstance;const r=s.tmdb_id||s.id;r&&i&&this.isMediaHidden(r,s.media_type,n,i)||e.appendChild(this.createMediaCard(s,a))})):e.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No trending content available</p>')}_buildTrendingUrl(){let e="./api/requestarr/discover/trending";const t=[];if(this.selectedMovieInstance){const s=b(this.selectedMovieInstance);s.appType&&t.push(`movie_app_type=${encodeURIComponent(s.appType)}`),s.name&&t.push(`movie_instance_name=${encodeURIComponent(s.name)}`)}return this.selectedTVInstance&&t.push(`tv_instance_name=${encodeURIComponent(this.selectedTVInstance)}`),t.length>0&&(e+="?"+t.join("&")),e}async loadTrending(){const e=document.getElementById("trending-carousel");if(e)try{const t=this._buildTrendingUrl(),a=await(await fetch(t)).json(),n=a.results&&a.results.length>0?a.results:[];this.renderTrendingResults(e,n)}catch(t){console.error("[RequestarrDiscover] Error loading trending:",t),e.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load trending content</p>'}}renderPopularMoviesResults(e,t){if(!e)return;const s=b(this.selectedMovieInstance);t&&t.length>0?(e.innerHTML="",t.forEach(a=>{const n=a.tmdb_id||a.id;n&&s.name&&this.isMediaHidden(n,"movie",s.appType,s.name)||e.appendChild(this.createMediaCard(a,this.selectedMovieInstance||null))})):e.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No movies available</p>'}async loadPopularMovies(){const e=document.getElementById("popular-movies-carousel");if(e)try{const t=b(this.selectedMovieInstance);let s="./api/requestarr/discover/movies?page=1";t.name&&(s+=`&app_type=${t.appType}&instance_name=${encodeURIComponent(t.name)}`);const n=await(await fetch(s)).json(),i=n.results&&n.results.length>0?n.results:[];this.renderPopularMoviesResults(e,i)}catch(t){console.error("[RequestarrDiscover] Error loading popular movies:",t),e.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load movies</p>'}}renderPopularTVResults(e,t){if(!e)return;const s=this.selectedTVInstance;t&&t.length>0?(e.innerHTML="",t.forEach(a=>{const n=a.tmdb_id||a.id;n&&s&&this.isMediaHidden(n,"tv","sonarr",s)||e.appendChild(this.createMediaCard(a,this.selectedTVInstance||null))})):e.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No TV shows available</p>'}async loadPopularTV(){const e=document.getElementById("popular-tv-carousel");if(e)try{const t=this.selectedTVInstance;let s="./api/requestarr/discover/tv?page=1";t&&(s+=`&app_type=sonarr&instance_name=${encodeURIComponent(t)}`);const n=await(await fetch(s)).json(),i=n.results&&n.results.length>0?n.results:[];this.renderPopularTVResults(e,i)}catch(t){console.error("[RequestarrDiscover] Error loading popular TV:",t),e.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load TV shows</p>'}}setupMoviesInfiniteScroll(){const e=document.getElementById("movies-scroll-sentinel");!e||this.moviesObserver||(this.moviesObserver=new IntersectionObserver(t=>{t.forEach(s=>{s.isIntersecting&&this.moviesHasMore&&!this.isLoadingMovies&&this.loadMoreMovies()})},{root:null,rootMargin:"200px 0px",threshold:0}),this.moviesObserver.observe(e))}async loadMovies(e=1){const t=document.getElementById("movies-grid");if(!t||this.isLoadingMovies&&this.selectedMovieInstance===this.activeMovieInstance)return;this.isLoadingMovies=!0;const s=++this.moviesRequestToken,a=this.selectedMovieInstance;this.activeMovieInstance=a,this.moviesPage===1&&(t.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading movies...</p></div>');try{let n=`./api/requestarr/discover/movies?page=${this.moviesPage}&_=${Date.now()}`;if(this.selectedMovieInstance){const o=b(this.selectedMovieInstance);n+=`&app_type=${o.appType}&instance_name=${encodeURIComponent(o.name)}`}if(this.core.filters){const o=this.core.filters.getFilterParams();o&&(n+=`&${o}`)}const i=await fetch(n);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if(this.moviesPage===1&&(t.innerHTML=""),s!==this.moviesRequestToken||a!==this.selectedMovieInstance){console.log("[RequestarrContent] Cancelled stale movies request, but spinner already cleared");return}r.results&&r.results.length>0?(r.results.forEach(o=>{const l=o.tmdb_id||o.id;if(l&&this.selectedMovieInstance){const d=b(this.selectedMovieInstance);if(this.isMediaHidden(l,"movie",d.appType,d.name))return}t.appendChild(this.createMediaCard(o))}),r.has_more!==void 0?this.moviesHasMore=r.has_more:this.moviesHasMore=r.results.length>=20):(t.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No movies found</p>',r.has_more!==void 0?this.moviesHasMore=r.has_more:this.moviesHasMore=!1)}catch(n){console.error("[RequestarrContent] Error loading movies:",n),this.moviesPage===1&&(t.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load movies</p>')}finally{this.isLoadingMovies=!1;const n=document.getElementById("movies-scroll-sentinel");if(n&&this.moviesHasMore){const i=n.getBoundingClientRect(),r=window.innerHeight||document.documentElement.clientHeight;i.top<=r+200&&this.loadMoreMovies()}}}loadMoreMovies(){this.moviesHasMore&&!this.isLoadingMovies&&(this.moviesPage++,this.loadMovies(this.moviesPage))}async loadTV(e=1){const t=document.getElementById("tv-grid");if(!t||this.isLoadingTV&&this.selectedTVInstance===this.activeTVInstance)return;this.isLoadingTV=!0;const s=++this.tvRequestToken,a=this.selectedTVInstance;this.activeTVInstance=a,this.tvPage===1&&(t.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading TV shows...</p></div>');try{let n=`./api/requestarr/discover/tv?page=${this.tvPage}&_=${Date.now()}`;if(this.selectedTVInstance&&(n+=`&app_type=sonarr&instance_name=${encodeURIComponent(this.selectedTVInstance)}`),this.core.tvFilters){const o=this.core.tvFilters.getFilterParams();o&&(n+=`&${o}`)}const i=await fetch(n);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if(this.tvPage===1&&(t.innerHTML=""),s!==this.tvRequestToken||a!==this.selectedTVInstance){console.log("[RequestarrContent] Cancelled stale TV request, but spinner already cleared");return}r.results&&r.results.length>0?(r.results.forEach(o=>{const l=o.tmdb_id||o.id;l&&this.selectedTVInstance&&this.isMediaHidden(l,"tv","sonarr",this.selectedTVInstance)||t.appendChild(this.createMediaCard(o))}),r.has_more!==void 0?this.tvHasMore=r.has_more:this.tvHasMore=r.results.length>=20):(t.innerHTML='<p style="color: #888; text-align: center; width: 100%; padding: 40px;">No TV shows found</p>',r.has_more!==void 0?this.tvHasMore=r.has_more:this.tvHasMore=!1)}catch(n){console.error("[RequestarrContent] Error loading TV shows:",n),this.tvPage===1&&(t.innerHTML='<p style="color: #ef4444; text-align: center; width: 100%; padding: 40px;">Failed to load TV shows</p>')}finally{this.isLoadingTV=!1;const n=document.getElementById("tv-scroll-sentinel");if(n&&this.tvHasMore){const i=n.getBoundingClientRect(),r=window.innerHeight||document.documentElement.clientHeight;i.top<=r+200&&this.loadMoreTV()}}}setupTVInfiniteScroll(){const e=document.getElementById("tv-scroll-sentinel");!e||this.tvObserver||(this.tvObserver=new IntersectionObserver(t=>{t.forEach(s=>{s.isIntersecting&&this.tvHasMore&&!this.isLoadingTV&&this.loadMoreTV()})},{root:null,rootMargin:"200px 0px",threshold:0}),this.tvObserver.observe(e))}loadMoreTV(){this.tvHasMore&&!this.isLoadingTV&&(this.tvPage++,this.loadTV(this.tvPage))}createMediaCard(e,t=null){const s=document.createElement("div");s.className="media-card",s.setAttribute("data-tmdb-id",e.tmdb_id),s.setAttribute("data-media-type",e.media_type),s.itemData=e,s.suggestedInstance=t;const a=e.poster_path||"./static/images/blackout.jpg",n=e.year||"N/A",i=e.vote_average?e.vote_average.toFixed(1):"N/A",r=e.overview||"No description available.",o=e.in_library||!1,l=e.partial||!1,d=e.media_type==="movie"?(this.core.instances.radarr||[]).length>0||(this.core.instances.movie_hunt||[]).length>0:(this.core.instances.sonarr||[]).length>0,c=d?"media-card-meta":"media-card-meta no-hide",m=window.MediaUtils?window.MediaUtils.getStatusBadge(o,l,d):"";o&&s.classList.add("in-library");const v=!o?'<button class="media-card-request-btn"><i class="fas fa-download"></i> Request</button>':"";if(s.innerHTML=`
            <div class="media-card-poster">
                ${m}
                <img src="${a}" alt="${e.title}" onerror="this.src='./static/images/blackout.jpg'">
                <div class="media-card-overlay">
                    <div class="media-card-overlay-title">${e.title}</div>
                    <div class="media-card-overlay-content">
                        <div class="media-card-overlay-year">${n}</div>
                        <div class="media-card-overlay-description">${r}</div>
                        ${v}
                    </div>
                </div>
            </div>
            <div class="media-card-info">
                <div class="media-card-title" title="${e.title}">${e.title}</div>
                <div class="${c}">
                    <span class="media-card-year">${n}</span>
                    <span class="media-card-rating">
                        <i class="fas fa-star"></i>
                        ${i}
                    </span>
                    ${window.MediaUtils?window.MediaUtils.getActionButton(o,l,d):""}
                </div>
            </div>
        `,!a.includes("./static/images/")&&window.getCachedTMDBImage&&window.tmdbImageCache){const p=s.querySelector(".media-card-poster img");p&&window.getCachedTMDBImage(a,window.tmdbImageCache).then(I=>{I&&I!==a&&(p.src=I)}).catch(I=>{console.error("[RequestarrContent] Failed to cache image:",I)})}const y=s.querySelector(".media-card-request-btn"),g=s.querySelector(".media-card-hide-btn"),f=s.querySelector(".media-card-delete-btn");return s.style.cursor="pointer",s.addEventListener("click",p=>{if(y&&(p.target===y||y.contains(p.target))){p.preventDefault(),p.stopPropagation(),this.core.modal.openModal(e.tmdb_id,e.media_type,s.suggestedInstance);return}if(f&&(p.target===f||f.contains(p.target))){p.preventDefault(),p.stopPropagation(),this._openDeleteModal(e,s);return}if(g&&(p.target===g||g.contains(p.target))){p.preventDefault(),p.stopPropagation(),this.hideMedia(e.tmdb_id,e.media_type,e.title,s);return}if(e.media_type==="movie")if(window.RequestarrDetail&&window.RequestarrDetail.openDetail){const I={tmdb_id:e.tmdb_id,id:e.tmdb_id,title:e.title,year:e.year,poster_path:e.poster_path,backdrop_path:e.backdrop_path,overview:e.overview,vote_average:e.vote_average,in_library:o};window.RequestarrDetail.openDetail(I,{suggestedInstance:s.suggestedInstance})}else this.core.modal.openModal(e.tmdb_id,e.media_type,s.suggestedInstance);else this.core.modal.openModal(e.tmdb_id,e.media_type,s.suggestedInstance)}),s}_openDeleteModal(e,t){if(!window.MovieCardDeleteModal){console.error("[RequestarrContent] MovieCardDeleteModal not loaded");return}const s=e.in_library||!1,a=e.partial||!1,n=s?"available":"requested";let i="movie_hunt",r="",o="";const l=this.selectedMovieInstance||t.suggestedInstance||"";if(l){const d=b(l);i=d.appType||"movie_hunt",r=d.name||""}if(this.core&&this.core.instances){const c=(this.core.instances[i]||[]).find(m=>m.name===r);c&&(o=c.id||"")}window.MovieCardDeleteModal.open(e,{instanceName:r,instanceId:o,status:n,hasFile:s,appType:i,onDeleted:function(){window.MediaUtils.animateCardRemoval(t)}})}hideMedia(e,t,s,a){const n=this,r=(a.itemData||{}).poster_path||null;let o,l;if(t==="movie"){const d=n.selectedMovieInstance||a.suggestedInstance||"";if(d){const c=b(d);o=c.appType,l=c.name}else if(n.core&&n.core.instances){const c=n.core.instances.movie_hunt||[],m=n.core.instances.radarr||[];c.length>0?(o="movie_hunt",l=c[0].name):m.length>0?(o="radarr",l=m[0].name):(o="radarr",l=null)}else o="radarr",l=null}else if(o="sonarr",l=n.selectedTVInstance,!l&&a.suggestedInstance&&(l=a.suggestedInstance),!l&&n.core&&n.core.instances){const d=n.core.instances.sonarr||[];l=d.length>0?d[0].name:null}window.MediaUtils.hideMedia({tmdbId:e,mediaType:t,title:s,posterPath:r,appType:o||"radarr",instanceName:l||"",cardElement:a,hiddenMediaSet:n.hiddenMediaSet})}}class C{constructor(e){this.core=e}setupGlobalSearch(){const e=document.getElementById("global-search-input");e&&e.addEventListener("input",t=>{this.handleGlobalSearch(t.target.value)})}handleGlobalSearch(e){if(this.core.searchTimeouts.global&&clearTimeout(this.core.searchTimeouts.global),!e.trim()){this.hideElement("search-results-view"),this.showElement("requestarr-discover-view"),this.hideElement("requestarr-movies-view"),this.hideElement("requestarr-tv-view"),this.hideElement("requestarr-hidden-view"),this.hideElement("requestarr-settings-view");return}this.core.searchTimeouts.global=setTimeout(()=>{this.performGlobalSearch(e)},500)}async performGlobalSearch(e){const t=document.getElementById("search-results-view"),s=document.getElementById("search-results-grid");if(this.hideElement("requestarr-discover-view"),this.hideElement("requestarr-movies-view"),this.hideElement("requestarr-tv-view"),this.hideElement("requestarr-hidden-view"),this.hideElement("requestarr-settings-view"),t&&(t.style.display="block"),s)s.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Searching...</p></div>';else{console.error("[RequestarrSearch] search-results-grid not found");return}try{let a="radarr",n="";const i=this.core.content?this.core.content.selectedMovieInstance:null;if(i&&i.includes(":")){const h=i.indexOf(":");a=i.substring(0,h),n=i.substring(h+1)}else i&&(n=i);const r=(this.core.content?this.core.content.selectedTVInstance:"")||"",[o,l]=await Promise.all([fetch(`./api/requestarr/search?q=${encodeURIComponent(e)}&app_type=${encodeURIComponent(a)}&instance_name=${encodeURIComponent(n)}`),fetch(`./api/requestarr/search?q=${encodeURIComponent(e)}&app_type=sonarr&instance_name=${encodeURIComponent(r)}`)]),d=await o.json(),c=await l.json(),m=[...d.results||[],...c.results||[]];m.sort((h,v)=>{const y=h.popularity||0;return(v.popularity||0)-y}),m.length>0?(s.innerHTML="",m.forEach(h=>{const v=h.media_type==="movie"?i:r;s.appendChild(this.core.content.createMediaCard(h,v))})):s.innerHTML='<p style="color: #888; text-align: center; padding: 60px; width: 100%;">No results found</p>'}catch(a){console.error("[RequestarrDiscover] Error searching:",a),s.innerHTML='<p style="color: #ef4444; text-align: center; padding: 60px; width: 100%;">Search failed</p>'}}hideElement(e){const t=document.getElementById(e);t&&(t.style.display="none")}showElement(e){const t=document.getElementById(e);t&&(t.style.display="block")}}class F{constructor(e){this.core=e}async openModal(e,t,s=null){const a=document.getElementById("media-modal");if(!a)return;await this.loadModalPreferences(),a.parentElement!==document.body&&document.body.appendChild(a),document.body.classList.add("requestarr-modal-open"),a.style.display="flex";const n=document.getElementById("requestarr-modal-title"),i=document.getElementById("requestarr-modal-label"),r=document.getElementById("requestarr-modal-meta"),o=document.getElementById("requestarr-modal-status-container"),l=document.getElementById("requestarr-modal-poster-img"),d=document.getElementById("modal-request-btn"),c=document.getElementById("modal-instance-select"),m=document.getElementById("modal-root-folder"),h=document.getElementById("modal-quality-profile");n&&(n.textContent="Loading..."),i&&(i.textContent=t==="tv"?"Request Series":"Request Movie"),r&&(r.textContent=""),o&&(o.innerHTML='<span class="mh-req-badge mh-req-badge-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</span>'),l&&(l.src="./static/images/blackout.jpg"),d&&(d.disabled=!0,d.textContent="Request",d.classList.remove("disabled","success")),c&&(c.innerHTML='<option value="">Loading...</option>'),m&&(m.innerHTML='<option value="">Loading...</option>'),h&&(h.innerHTML='<option value="">Loading...</option>');const v=document.getElementById("requestarr-modal-min-availability-wrap"),y=document.getElementById("requestarr-modal-start-search-wrap");v&&v.classList.add("mh-hidden"),y&&y.classList.add("mh-hidden");const g=this,f=document.getElementById("requestarr-modal-backdrop"),p=document.getElementById("requestarr-modal-close"),I=document.getElementById("requestarr-modal-cancel"),M=document.getElementById("modal-start-search"),w=document.getElementById("modal-minimum-availability");f&&(f.onclick=()=>g.closeModal()),p&&(p.onclick=()=>g.closeModal()),I&&(I.onclick=()=>g.closeModal()),d&&(d.onclick=()=>g.submitRequest()),M&&(M.onchange=()=>{this.saveModalPreferences({start_search:M.checked})}),w&&(w.onchange=()=>{this.saveModalPreferences({minimum_availability:w.value})}),this.suggestedInstance=s;try{const _=await(await fetch(`./api/requestarr/details/${t}/${e}`)).json();if(_.tmdb_id)this.core.currentModal=_,this.core.currentModalData=_,this.renderModal(_);else throw new Error("Failed to load details")}catch(E){console.error("[RequestarrModal] Error loading details:",E),n&&(n.textContent="Error"),o&&(o.innerHTML='<span class="mh-req-badge mh-req-badge-error"><i class="fas fa-exclamation-triangle"></i> Failed to load details</span>')}}async loadModalPreferences(){try{const t=await(await fetch("./api/requestarr/settings/modal-preferences")).json();t.success?this.preferences=t.preferences:this.preferences={start_search:!0,minimum_availability:"released",movie_instance:"",tv_instance:""}}catch(e){console.error("[RequestarrModal] Error loading preferences:",e),this.preferences={start_search:!0,minimum_availability:"released",movie_instance:"",tv_instance:""}}}async saveModalPreferences(e){try{await fetch("./api/requestarr/settings/modal-preferences",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),Object.assign(this.preferences,e)}catch(t){console.error("[RequestarrModal] Error saving preferences:",t)}}renderModal(e){const t=e.media_type==="tv";let s=[];if(t)s=this.core.instances.sonarr.reduce((f,p)=>(f.find(I=>I.name===p.name)||f.push({...p,appType:"sonarr",compoundValue:p.name}),f),[]);else{const g=this.core.instances.movie_hunt||[],f=this.core.instances.radarr||[],p=new Set;g.forEach(I=>{p.has(I.name)||(p.add(I.name),s.push({...I,appType:"movie_hunt",compoundValue:S("movie_hunt",I.name),label:`Movie Hunt – ${I.name}`}))}),f.forEach(I=>{p.has(`radarr-${I.name}`)||(p.add(`radarr-${I.name}`),s.push({...I,appType:"radarr",compoundValue:S("radarr",I.name),label:`Radarr – ${I.name}`}))})}const a=t?this.preferences?.tv_instance||this.core.content.selectedTVInstance:this.preferences?.movie_instance||this.core.content.selectedMovieInstance,n=this.suggestedInstance||a||s[0]?.compoundValue||s[0]?.name||"";let i=n,r=!1;if(!t&&n){const g=s.find(f=>f.compoundValue===n||f.name===n);g&&(i=g.compoundValue||g.name,r=g.appType==="movie_hunt")}else if(t&&n){const g=s.find(f=>f.name===n);g&&(r=g.appType==="movie_hunt")}console.log("[RequestarrModal] Resolved instance:",i,"isMovieHunt:",r);const o=document.getElementById("requestarr-modal-poster-img");o&&(o.src=e.poster_path||"./static/images/blackout.jpg");const l=document.getElementById("requestarr-modal-title");l&&(l.textContent=e.title||"");const d=document.getElementById("requestarr-modal-label");d&&(d.textContent=t?"Request Series":"Request Movie");const c=document.getElementById("requestarr-modal-meta");if(c){const g=[];if(e.year&&g.push(String(e.year)),e.genres&&e.genres.length){const f=e.genres.slice(0,3).map(p=>typeof p=="string"?p:p.name||"").filter(Boolean);f.length&&g.push(f.join(", "))}c.textContent=g.join("  ·  ")}const m=document.getElementById("modal-instance-select");m&&(m.innerHTML="",s.length===0?m.innerHTML='<option value="">No Instance Configured</option>':s.forEach(g=>{const f=document.createElement("option");f.value=g.compoundValue||g.name,f.textContent=g.label||`${t?"Sonarr":"Radarr"} – ${g.name}`,(g.compoundValue||g.name)===i&&(f.selected=!0),m.appendChild(f)}),m.onchange=()=>this.instanceChanged(m.value));const h=document.getElementById("modal-quality-profile");if(h){let g;if(t)g=`sonarr-${i}`;else{const p=b(i);g=`${p.appType}-${p.name}`}const f=this.core.qualityProfiles[g]||[];if(f.length===0&&i){h.innerHTML='<option value="">Loading profiles...</option>';const p=t?{appType:"sonarr",name:i}:b(i);this.core.loadQualityProfilesForInstance(p.appType,p.name).then(I=>{I&&I.length>0?this._populateQualityProfiles(h,I,r):this._populateQualityProfiles(h,[],r)})}else this._populateQualityProfiles(h,f,r)}const v=document.getElementById("requestarr-modal-status-container"),y=document.getElementById("modal-request-btn");if(y&&(y.disabled=!1,y.classList.remove("disabled","success"),y.textContent="Request"),this._applyMovieHuntModalMode(i,t,d,y),i)v&&(v.innerHTML='<span class="mh-req-badge mh-req-badge-loading"><i class="fas fa-spinner fa-spin"></i> Checking...</span>'),this.loadModalRootFolders(i,t),t?this.loadSeriesStatus(i):this.loadMovieStatus(i);else{v&&(v.innerHTML="");const g=document.getElementById("modal-root-folder");g&&(g.innerHTML='<option value="">Select an instance first</option>')}s.length===0&&y&&(y.disabled=!0,y.classList.add("disabled"))}async loadModalRootFolders(e,t){const s=document.getElementById("modal-root-folder");if(!s||this._loadingModalRootFolders)return;this._loadingModalRootFolders=!0;let a,n;if(t)a="sonarr",n=e;else{const i=b(e);a=i.appType,n=i.name}s.innerHTML='<option value="">Loading...</option>';try{const r=await(await fetch(`./api/requestarr/rootfolders?app_type=${a}&instance_name=${encodeURIComponent(n)}`)).json();if(r.success&&r.root_folders&&r.root_folders.length>0){const o=new Map;if(r.root_folders.forEach(l=>{if(!l||!l.path)return;const d=l.path.trim(),c=d.replace(/\/+$/,"").toLowerCase();c&&(o.has(c)||o.set(c,{path:d,freeSpace:l.freeSpace,isDefault:!!l.is_default}))}),o.size===0)s.innerHTML='<option value="">Use default (first root folder)</option>';else{s.innerHTML="";let l=!1,d=null;o.forEach(c=>{const m=document.createElement("option");m.value=c.path,m.textContent=c.path+(c.freeSpace!=null?` (${Math.round(c.freeSpace/1e9)} GB free)`:""),c.isDefault&&(m.selected=!0,l=!0),d||(d=c.path),s.appendChild(m)}),!l&&d&&(s.value=d)}}else s.innerHTML='<option value="">Use default (first root folder)</option>'}catch(i){console.error("[RequestarrModal] Error loading root folders:",i),s.innerHTML='<option value="">Use default (first root folder)</option>'}finally{this._loadingModalRootFolders=!1}}async loadSeriesStatus(e){if(!e||!this.core.currentModalData)return;const t=document.getElementById("requestarr-modal-status-container");if(t){t.innerHTML='<span class="mh-req-badge mh-req-badge-loading"><i class="fas fa-spinner fa-spin"></i> Checking...</span>';try{const a=await(await fetch(`./api/requestarr/series-status?tmdb_id=${this.core.currentModalData.tmdb_id}&instance=${encodeURIComponent(e)}`)).json(),n=document.getElementById("modal-request-btn");a.exists?a.missing_episodes===0&&a.total_episodes>0?(t.innerHTML=`<span class="mh-req-badge mh-req-badge-lib"><i class="fas fa-check-circle"></i> Complete (${a.available_episodes}/${a.total_episodes} episodes)</span>`,n&&(n.disabled=!0,n.classList.add("disabled"),n.textContent="Complete")):a.missing_episodes>0?(t.innerHTML=`<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-tv"></i> ${a.missing_episodes} missing episodes (${a.available_episodes}/${a.total_episodes})</span>`,n&&(n.disabled=!1,n.classList.remove("disabled"),n.textContent="Request")):(t.innerHTML='<span class="mh-req-badge mh-req-badge-lib"><i class="fas fa-check-circle"></i> In Library</span>',n&&(n.disabled=!0,n.classList.add("disabled"),n.textContent="In Library")):(t.innerHTML='<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to request</span>',n&&(n.disabled=!1,n.classList.remove("disabled"),n.textContent="Request"))}catch(s){console.error("[RequestarrModal] Error loading series status:",s),t.innerHTML='<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to request</span>'}}}async loadMovieStatus(e){if(!e||!this.core.currentModalData)return;const t=document.getElementById("requestarr-modal-status-container");if(t){t.innerHTML='<span class="mh-req-badge mh-req-badge-loading"><i class="fas fa-spinner fa-spin"></i> Checking...</span>';try{const s=b(e),a=s.appType==="movie_hunt",n=a?"&app_type=movie_hunt":"",r=await(await fetch(`./api/requestarr/movie-status?tmdb_id=${this.core.currentModalData.tmdb_id}&instance=${encodeURIComponent(s.name)}${n}`)).json(),o=document.getElementById("modal-request-btn");r.in_library?(t.innerHTML='<span class="mh-req-badge mh-req-badge-lib"><i class="fas fa-check-circle"></i> Already in library</span>',o&&(o.disabled=!0,o.classList.add("disabled"),o.textContent="Already in library"),this._syncCardBadge(this.core.currentModalData.tmdb_id,!0)):r.previously_requested?(t.innerHTML=a?'<span class="mh-req-badge mh-req-badge-warn"><i class="fas fa-clock"></i> Requested — waiting for download</span>':'<span class="mh-req-badge mh-req-badge-warn"><i class="fas fa-clock"></i> Previously requested</span>',o&&(o.disabled=!1,o.classList.remove("disabled"),o.textContent=a?"Add to Library":"Request"),this._syncCardBadge(this.core.currentModalData.tmdb_id,!1,!0)):(t.innerHTML=a?'<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to add</span>':'<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to request</span>',o&&(o.disabled=!1,o.classList.remove("disabled"),o.textContent=a?"Add to Library":"Request"))}catch(s){console.error("[RequestarrModal] Error loading movie status:",s);const a=e&&b(e).appType==="movie_hunt";t.innerHTML=a?'<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to add</span>':'<span class="mh-req-badge mh-req-badge-ok"><i class="fas fa-check-circle"></i> Available to request</span>';const n=document.getElementById("modal-request-btn");n&&(n.disabled=!1,n.classList.remove("disabled"),n.textContent=a?"Add to Library":"Request")}}}_applyMovieHuntModalMode(e,t,s,a){const n=document.getElementById("requestarr-modal-min-availability-wrap"),i=document.getElementById("requestarr-modal-start-search-wrap"),r=document.getElementById("modal-minimum-availability"),o=document.getElementById("modal-start-search"),l=!t&&e&&b(e).appType==="movie_hunt";n&&n.classList.toggle("mh-hidden",!l),i&&i.classList.toggle("mh-hidden",!l),r&&(r.value=this.preferences?.minimum_availability||"released"),o&&(o.checked=this.preferences?.hasOwnProperty("start_search")?this.preferences.start_search:!0),s&&(s.textContent=t?"Request Series":l?"Add to Library":"Request Movie"),a&&!a.disabled&&(a.textContent=l?"Add to Library":"Request")}instanceChanged(e){const t=this.core.currentModalData.media_type==="tv";t?this.saveModalPreferences({tv_instance:e}):this.saveModalPreferences({movie_instance:e}),console.log("[RequestarrModal] Instance changed to:",e);const s=document.getElementById("requestarr-modal-label"),a=document.getElementById("modal-request-btn");this._applyMovieHuntModalMode(e,t,s,a),this.loadModalRootFolders(e,t);const n=document.getElementById("modal-quality-profile");if(n){let i,r=!1;if(t)i=`sonarr-${e}`;else{const l=b(e);i=`${l.appType}-${l.name}`,r=l.appType==="movie_hunt"}const o=this.core.qualityProfiles[i]||[];if(o.length===0&&e){n.innerHTML='<option value="">Loading profiles...</option>';const l=t?{appType:"sonarr",name:e}:b(e);this.core.loadQualityProfilesForInstance(l.appType,l.name).then(d=>{d&&d.length>0?this._populateQualityProfiles(n,d,r):this._populateQualityProfiles(n,[],r)})}else this._populateQualityProfiles(n,o,r)}t?this.loadSeriesStatus(e):this.loadMovieStatus(e)}_populateQualityProfiles(e,t,s){if(e.innerHTML="",s){if(t.length===0){e.innerHTML='<option value="">No profiles configured</option>';return}let a=t.findIndex(n=>n.is_default);a===-1&&(a=0),t.forEach((n,i)=>{const r=document.createElement("option");r.value=n.id,r.textContent=n.name,i===a&&(r.selected=!0),e.appendChild(r)})}else e.innerHTML='<option value="">Any (Default)</option>',t.forEach(a=>{if(a.name.toLowerCase()!=="any"){const n=document.createElement("option");n.value=a.id,n.textContent=a.name,e.appendChild(n)}})}async submitRequest(){const e=document.getElementById("modal-instance-select"),t=document.getElementById("modal-quality-profile"),s=t?t.value:"",a=document.getElementById("modal-root-folder"),n=a&&a.value?a.value:"",i=document.getElementById("modal-request-btn");if(!e||!e.value){this.core.showNotification("Please select an instance","error");return}if(!this.core.currentModalData){this.core.showNotification("No media data available","error");return}const r=this.core.currentModalData.media_type==="tv";try{let o,l;if(r)o=e.value,l="sonarr";else{const h=b(e.value);o=h.name,l=h.appType}i.disabled=!0,i.textContent=l==="movie_hunt"?"Adding...":"Requesting...";const d={tmdb_id:this.core.currentModalData.tmdb_id,media_type:this.core.currentModalData.media_type,title:this.core.currentModalData.title,year:this.core.currentModalData.year,overview:this.core.currentModalData.overview||"",poster_path:this.core.currentModalData.poster_path||"",backdrop_path:this.core.currentModalData.backdrop_path||"",instance:o,app_type:l,root_folder_path:n||void 0,quality_profile:s};if(l==="movie_hunt"){const h=document.getElementById("modal-start-search"),v=document.getElementById("modal-minimum-availability");d.start_search=h?h.checked:!0,d.minimum_availability=v&&v.value?v.value:"released"}const m=await(await fetch("./api/requestarr/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();if(m.success){i.textContent=l==="movie_hunt"?"Added ✓":"Requested ✓",i.classList.add("success");const h=m.message||(l==="movie_hunt"?"Successfully added to library.":`${r?"Series":"Movie"} requested successfully!`);this.core.showNotification(h,"success");const v=this.core.currentModalData.tmdb_id,y=this.core.currentModalData.media_type;this._syncCardBadge(v,!1,!0),window.dispatchEvent(new CustomEvent("requestarr-request-success",{detail:{tmdbId:v,mediaType:y,appType:l,instanceName:o}})),setTimeout(()=>{this._refreshCardStatusFromAPI(v)},3e3),setTimeout(()=>{this._refreshCardStatusFromAPI(v)},8e3),setTimeout(()=>this.closeModal(),2e3)}else{const h=m.message||m.error||"Request failed";this.core.showNotification(h,"error"),i.disabled=!1,i.classList.remove("success"),i.textContent=l==="movie_hunt"?"Add to Library":"Request"}}catch(o){console.error("[RequestarrModal] Error submitting request:",o),this.core.showNotification(o.message||"Request failed","error"),i.disabled=!1,i.classList.remove("success");const l=e.value?r?{appType:"sonarr"}:b(e.value):null;i.textContent=l&&l.appType==="movie_hunt"?"Add to Library":"Request"}}_syncCardBadge(e,t,s){document.querySelectorAll(`.media-card[data-tmdb-id="${e}"]`).forEach(n=>{const i=n.querySelector(".media-card-status-badge");if(i&&(t?(i.className="media-card-status-badge complete",i.innerHTML='<i class="fas fa-check"></i>',n.classList.add("in-library")):s&&(i.className="media-card-status-badge partial",i.innerHTML='<i class="fas fa-bookmark"></i>')),t||s){const r=n.querySelector(".media-card-hide-btn");r&&(r.className="media-card-delete-btn",r.title="Remove / Delete",r.innerHTML='<i class="fas fa-trash-alt"></i>');const o=n.querySelector(".media-card-request-btn");o&&o.remove()}})}async _refreshCardStatusFromAPI(e){try{const t=document.getElementById("modal-instance-select"),s=t?t.value:"";if(!s)return;const a=b(s),n=a.appType==="movie_hunt"?"&app_type=movie_hunt":"",r=await(await fetch(`./api/requestarr/movie-status?tmdb_id=${e}&instance=${encodeURIComponent(a.name)}${n}`)).json();this._syncCardBadge(e,r.in_library||!1,r.previously_requested||!1)}catch(t){console.warn("[RequestarrModal] Failed to refresh card status from API:",t)}}closeModal(){const e=document.getElementById("media-modal");e&&(e.style.display="none"),this.core.currentModalData=null,document.body.classList.remove("requestarr-modal-open")}}class H{constructor(e){this.core=e,this.hiddenMediaControlsInitialized=!1,this.hiddenMediaItems=[],this.blacklistedTvGenres=[],this.blacklistedMovieGenres=[],this.tvGenresForBlacklist=[],this.movieGenresForBlacklist=[],this.hiddenMediaState={mediaType:null,instanceValue:"",searchQuery:"",page:1,pageSize:20}}async loadHistory(){const e=document.getElementById("history-list");if(e){e.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading history...</p></div>';try{const s=await(await fetch("./api/requestarr/history")).json();s.requests&&s.requests.length>0?(e.innerHTML="",(await Promise.all(s.requests.map(n=>this.createHistoryItem(n)))).forEach(n=>e.appendChild(n))):e.innerHTML='<p style="color: #888; text-align: center; padding: 60px;">No request history</p>'}catch(t){console.error("[RequestarrDiscover] Error loading history:",t),e.innerHTML='<p style="color: #ef4444; text-align: center; padding: 60px;">Failed to load history</p>'}}}async createHistoryItem(e){const t=document.createElement("div");t.className="history-item";const s=e.poster_path||"./static/images/no-poster.png",a=new Date(e.requested_at).toLocaleDateString();if(t.innerHTML=`
            <div class="history-poster">
                <img src="${s}" alt="${e.title}">
            </div>
            <div class="history-info">
                <div class="history-title">${e.title} (${e.year||"N/A"})</div>
                <div class="history-meta">
                    Requested to ${e.app_type==="radarr"?"Radarr":"Sonarr"} - ${e.instance_name} on ${a}
                </div>
                <span class="history-status">Requested</span>
            </div>
        `,!s.includes("./static/images/")&&window.getCachedTMDBImage&&window.tmdbImageCache)try{const n=await window.getCachedTMDBImage(s,window.tmdbImageCache);if(n&&n!==s){const i=t.querySelector(".history-poster img");i&&(i.src=n)}}catch(n){console.error("[RequestarrSettings] Failed to cache history image:",n)}return t}async loadHiddenMedia(e=null,t=1){const s=document.getElementById("hidden-media-grid");if(!s)return;this.initializeHiddenMediaControls(),this.hiddenMediaState.mediaType!==e?(this.hiddenMediaState.mediaType=e,this.hiddenMediaState.page=1):this.hiddenMediaState.page=t;const n=document.getElementById("hidden-media-instance");if(n&&(!n.options||n.options.length<=1)&&await this.loadHiddenMediaInstances(),n&&!this.hiddenMediaState.instanceValue&&(this.hiddenMediaState.instanceValue=n.value||""),!this.hiddenMediaState.instanceValue&&n&&n.options&&n.options.length>1){const i=Array.from(n.options).find(r=>r.value&&r.value.includes("::"));i&&(i.selected=!0,this.hiddenMediaState.instanceValue=i.value)}if(!this.hiddenMediaState.instanceValue){s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.innerHTML=`
                <div style="text-align: center; color: #9ca3af; max-width: 600px;">
                    <i class="fas fa-eye-slash" style="font-size: 64px; margin-bottom: 30px; opacity: 0.4; display: block;"></i>
                    <p style="font-size: 20px; margin-bottom: 15px; font-weight: 500; white-space: nowrap;">No Instance Selected</p>
                    <p style="font-size: 15px; line-height: 1.6; opacity: 0.8;">Please select an instance from the dropdown above to view hidden media.</p>
                </div>
            `;return}s.style.display="grid",s.style.alignItems="",s.style.justifyContent="",s.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Loading hidden media...</p></div>';try{const i=this.parseHiddenMediaInstanceValue(this.hiddenMediaState.instanceValue),r=`${e||"all"}|${i.appType||"all"}|${i.instanceName||"all"}`;this.hiddenMediaFetchKey!==r&&(this.hiddenMediaFetchKey=r,this.hiddenMediaItems=await this.fetchHiddenMediaItems(e,i)),this.renderHiddenMediaPage()}catch(i){console.error("[RequestarrSettings] Error loading hidden media:",i),s.innerHTML='<p style="color: #ef4444; text-align: center; padding: 60px;">Failed to load hidden media.</p>'}}initializeHiddenMediaControls(){if(this.hiddenMediaControlsInitialized)return;const e=document.getElementById("hidden-media-search");e&&e.addEventListener("input",s=>{const a=s.target.value||"";clearTimeout(this.hiddenMediaSearchTimeout),this.hiddenMediaSearchTimeout=setTimeout(()=>{this.hiddenMediaState.searchQuery=a.trim(),this.hiddenMediaState.page=1,this.renderHiddenMediaPage()},200)});const t=document.getElementById("hidden-media-instance");t&&t.addEventListener("change",()=>{this.hiddenMediaState.instanceValue=t.value||"",this.hiddenMediaState.page=1,this.hiddenMediaFetchKey=null,this.loadHiddenMedia(null,1)}),this.loadHiddenMediaInstances(),this.hiddenMediaControlsInitialized=!0}async loadHiddenMediaInstances(){const e=document.getElementById("hidden-media-instance");if(e)try{const t=Date.now(),[s,a,n]=await Promise.all([fetch(`./api/requestarr/instances/movie_hunt?t=${t}`,{cache:"no-store"}),fetch(`./api/requestarr/instances/radarr?t=${t}`,{cache:"no-store"}),fetch(`./api/requestarr/instances/sonarr?t=${t}`,{cache:"no-store"})]),i=await s.json(),r=await a.json(),o=await n.json(),l=[];if((i.instances||[]).forEach(d=>{d&&d.name&&l.push({value:`movie_hunt::${d.name}`,label:`Movie Hunt – ${d.name}`})}),(r.instances||[]).forEach(d=>{d&&d.name&&l.push({value:`radarr::${d.name}`,label:`Radarr – ${d.name}`})}),(o.instances||[]).forEach(d=>{d&&d.name&&l.push({value:`sonarr::${d.name}`,label:`Sonarr – ${d.name}`})}),e.innerHTML="",l.length===0){const d=document.createElement("option");d.value="",d.textContent="No Instances Exist",e.appendChild(d)}else{const d=document.createElement("option");d.value="",d.textContent="Select an Instance",e.appendChild(d),l.forEach(c=>{const m=document.createElement("option");m.value=c.value,m.textContent=c.label,e.appendChild(m)})}}catch(t){console.error("[RequestarrSettings] Error loading hidden media instances:",t),e.innerHTML='<option value="">No instances available</option>'}}parseHiddenMediaInstanceValue(e){if(!e)return{appType:null,instanceName:null};const[t,s]=e.split("::");return!t||!s?{appType:null,instanceName:null}:{appType:t,instanceName:s}}async fetchHiddenMediaItems(e,t){const s=[];let n=1,i=1;const r=50;for(;n<=i&&n<=r;){let o=`./api/requestarr/hidden-media?page=${n}&page_size=200`;e&&(o+=`&media_type=${e}`),t.appType&&t.instanceName&&(o+=`&app_type=${encodeURIComponent(t.appType)}&instance_name=${encodeURIComponent(t.instanceName)}`);const l=await fetch(o);if(!l.ok)throw new Error(`Hidden media API error: ${l.status}`);const d=await l.json();d.hidden_media&&d.hidden_media.length>0&&s.push(...d.hidden_media),i=d.total_pages||1,n+=1}return s}getFilteredHiddenMedia(){const e=(this.hiddenMediaState.searchQuery||"").toLowerCase();let t=this.hiddenMediaItems.slice();return e&&(t=t.filter(s=>(s.title||"").toLowerCase().includes(e))),t.sort((s,a)=>{const n=(s.title||"").toLowerCase(),i=(a.title||"").toLowerCase();return n.localeCompare(i)}),t}renderHiddenMediaPage(){const e=document.getElementById("hidden-media-grid"),t=document.getElementById("hidden-media-pagination");if(!e||!t)return;const s=this.getFilteredHiddenMedia(),a=this.hiddenMediaState.pageSize,n=Math.max(1,Math.ceil(s.length/a));this.hiddenMediaState.page>n&&(this.hiddenMediaState.page=1);const i=(this.hiddenMediaState.page-1)*a,r=s.slice(i,i+a);r.length>0?(e.style.display="grid",e.style.alignItems="",e.style.justifyContent="",e.innerHTML="",r.forEach(o=>{e.appendChild(this.createHiddenMediaCard(o))}),n>1?(t.style.display="flex",document.getElementById("hidden-page-info").textContent=`Page ${this.hiddenMediaState.page} of ${n}`,document.getElementById("hidden-prev-page").disabled=this.hiddenMediaState.page===1,document.getElementById("hidden-next-page").disabled=this.hiddenMediaState.page===n):t.style.display="none"):(e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.innerHTML=`
                <div style="text-align: center; color: #9ca3af; max-width: 600px;">
                    <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 30px; opacity: 0.4; display: block;"></i>
                    <p style="font-size: 20px; margin-bottom: 15px; font-weight: 500; white-space: nowrap;">No Hidden Media</p>
                    <p style="font-size: 15px; line-height: 1.6; opacity: 0.8;">There are no hidden items for this instance.</p>
                </div>
            `,t.style.display="none"),this.setupHiddenMediaPagination(n)}setupHiddenMediaPagination(e){const t=document.getElementById("hidden-prev-page"),s=document.getElementById("hidden-next-page");!t||!s||(t.onclick=()=>{this.hiddenMediaState.page>1&&(this.hiddenMediaState.page-=1,this.renderHiddenMediaPage())},s.onclick=()=>{this.hiddenMediaState.page<e&&(this.hiddenMediaState.page+=1,this.renderHiddenMediaPage())})}createHiddenMediaCard(e){const t=document.createElement("div");t.className="media-card",t.setAttribute("data-tmdb-id",e.tmdb_id),t.setAttribute("data-media-type",e.media_type);const s=e.poster_path||"./static/images/blackout.jpg";if(t.innerHTML=`
            <div class="media-card-poster">
                <button class="media-card-unhide-btn" title="Unhide this media">
                    <i class="fas fa-eye"></i>
                </button>
                <img src="${s}" alt="${e.title}" onerror="this.src='./static/images/blackout.jpg'">
            </div>
        `,!s.includes("./static/images/")&&window.getCachedTMDBImage&&window.tmdbImageCache){const n=t.querySelector(".media-card-poster img");n&&window.getCachedTMDBImage(s,window.tmdbImageCache).then(i=>{i&&i!==s&&(n.src=i)}).catch(()=>{})}const a=t.querySelector(".media-card-unhide-btn");return a&&a.addEventListener("click",async n=>{n.stopPropagation(),await this.unhideMedia(e.tmdb_id,e.media_type,e.app_type,e.instance_name,e.title,t)}),t}async unhideMedia(e,t,s,a,n,i){const r=this,o=async function(){try{if(!(await fetch(`./api/requestarr/hidden-media/${e}/${t}/${s}/${a}`,{method:"DELETE"})).ok)throw new Error("Failed to unhide media");r.hiddenMediaItems=r.hiddenMediaItems.filter(d=>!(d.tmdb_id===e&&d.media_type===t&&d.app_type===s&&d.instance_name===a)),r.renderHiddenMediaPage(),console.log(`[RequestarrSettings] Unhidden media: ${n} (${t})`)}catch(l){console.error("[RequestarrSettings] Error unhiding media:",l),window.huntarrUI&&window.huntarrUI.showNotification&&window.huntarrUI.showNotification("Failed to unhide media. Please try again.","error")}};window.HuntarrConfirm.show({title:"Unhide Media",message:`Unhide "${n}"?<br><br>This will make it visible in ${s}/${a} again.`,confirmLabel:"Unhide",onConfirm:function(){o()}})}async loadSettings(){await this.loadDiscoverFilters(),await this.loadBlacklistedGenres();const e=document.getElementById("save-discover-filters");e&&(e.onclick=()=>this.saveDiscoverFilters());const t=document.getElementById("save-blacklisted-genres-btn");t&&(t.onclick=()=>this.saveBlacklistedGenres());const s=this;window._reqsetSaveAll=async function(){const a=document.getElementById("reqset-save-all-btn");a&&(a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{await s.saveDiscoverFilters(!0),await s.saveBlacklistedGenres(!0),window.huntarrUI&&window.huntarrUI.showNotification&&window.huntarrUI.showNotification("All settings saved","success")}catch(n){console.error("[Requestarr Settings] Save all error:",n),window.huntarrUI&&window.huntarrUI.showNotification&&window.huntarrUI.showNotification("Error saving settings","error")}finally{a&&(a.disabled=!1,a.innerHTML='<i class="fas fa-save"></i> Save')}}}async loadBlacklistedGenres(){const e=document.getElementById("blacklist-tv-genre-select"),t=document.getElementById("blacklist-movie-genre-select");if(!(!e||!t))try{const[s,a,n]=await Promise.all([fetch("./api/requestarr/genres/tv"),fetch("./api/requestarr/genres/movie"),fetch("./api/requestarr/settings/blacklisted-genres")]),i=await s.json(),r=await a.json(),o=await n.json();this.tvGenresForBlacklist=i.genres||[],this.movieGenresForBlacklist=r.genres||[];const l=(o.blacklisted_tv_genres||[]).map(c=>parseInt(c,10)),d=(o.blacklisted_movie_genres||[]).map(c=>parseInt(c,10));this.blacklistedTvGenres=l.map(c=>{const m=this.tvGenresForBlacklist.find(h=>h.id===c);return{id:c,name:m&&m.name?m.name:`Genre ${c}`}}),this.blacklistedMovieGenres=d.map(c=>{const m=this.movieGenresForBlacklist.find(h=>h.id===c);return{id:c,name:m&&m.name?m.name:`Genre ${c}`}}),this.populateBlacklistedDropdowns(),this.renderBlacklistedPills(),e.onchange=()=>{const c=e.value;if(!c)return;const m=parseInt(c,10),h=this.tvGenresForBlacklist.find(v=>v.id===m);h&&!this.blacklistedTvGenres.some(v=>v.id===m)&&(this.blacklistedTvGenres.push({id:h.id,name:h.name}),this.renderBlacklistedPills(),this.populateBlacklistedDropdowns()),e.value=""},t.onchange=()=>{const c=t.value;if(!c)return;const m=parseInt(c,10),h=this.movieGenresForBlacklist.find(v=>v.id===m);h&&!this.blacklistedMovieGenres.some(v=>v.id===m)&&(this.blacklistedMovieGenres.push({id:h.id,name:h.name}),this.renderBlacklistedPills(),this.populateBlacklistedDropdowns()),t.value=""}}catch(s){console.error("[RequestarrDiscover] Error loading blacklisted genres:",s)}}populateBlacklistedDropdowns(){const e=document.getElementById("blacklist-tv-genre-select"),t=document.getElementById("blacklist-movie-genre-select");if(!e||!t)return;const s=this.blacklistedTvGenres.map(n=>n.id),a=this.blacklistedMovieGenres.map(n=>n.id);e.innerHTML='<option value="">Select a genre to blacklist...</option>',this.tvGenresForBlacklist.filter(n=>!s.includes(n.id)).forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,e.appendChild(i)}),t.innerHTML='<option value="">Select a genre to blacklist...</option>',this.movieGenresForBlacklist.filter(n=>!a.includes(n.id)).forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,t.appendChild(i)})}renderBlacklistedPills(){const e=document.getElementById("blacklisted-tv-genres-list"),t=document.getElementById("blacklisted-movie-genres-list");!e||!t||(e.innerHTML="",this.blacklistedTvGenres.forEach(s=>{const a=document.createElement("span");a.className="blacklisted-genre-pill",a.innerHTML=`<span class="remove-pill" data-type="tv" data-id="${s.id}" aria-label="Remove">×</span><span>${s.name}</span>`,a.querySelector(".remove-pill").onclick=()=>{this.blacklistedTvGenres=this.blacklistedTvGenres.filter(n=>n.id!==s.id),this.renderBlacklistedPills(),this.populateBlacklistedDropdowns()},e.appendChild(a)}),t.innerHTML="",this.blacklistedMovieGenres.forEach(s=>{const a=document.createElement("span");a.className="blacklisted-genre-pill",a.innerHTML=`<span class="remove-pill" data-type="movie" data-id="${s.id}" aria-label="Remove">×</span><span>${s.name}</span>`,a.querySelector(".remove-pill").onclick=()=>{this.blacklistedMovieGenres=this.blacklistedMovieGenres.filter(n=>n.id!==s.id),this.renderBlacklistedPills(),this.populateBlacklistedDropdowns()},t.appendChild(a)}))}async saveBlacklistedGenres(e=!1){const t=document.getElementById("save-blacklisted-genres-btn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{(await(await fetch("./api/requestarr/settings/blacklisted-genres",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({blacklisted_tv_genres:this.blacklistedTvGenres.map(n=>n.id),blacklisted_movie_genres:this.blacklistedMovieGenres.map(n=>n.id)})})).json()).success?e||this.core.showNotification("Blacklisted genres saved.","success"):this.core.showNotification("Failed to save blacklisted genres","error")}catch(s){console.error("[RequestarrDiscover] Error saving blacklisted genres:",s),this.core.showNotification("Failed to save blacklisted genres","error")}finally{t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save"></i> Save Blacklisted Genres')}}async loadDefaultInstances(){const{encodeInstanceValue:e,decodeInstanceValue:t}=await Promise.resolve().then(()=>L),s=document.getElementById("default-movie-instance"),a=document.getElementById("default-tv-instance");if(!(!s||!a))try{const n=Date.now(),r=await(await fetch(`./api/requestarr/instances/movie_hunt?t=${n}`,{cache:"no-store"})).json(),l=await(await fetch(`./api/requestarr/instances/radarr?t=${n}`,{cache:"no-store"})).json(),c=await(await fetch(`./api/requestarr/instances/sonarr?t=${n}`,{cache:"no-store"})).json(),h=await(await fetch("./api/requestarr/settings/default-instances")).json();let v=!1;const y=r.instances||[],g=l.instances||[],f=[];if(y.forEach(p=>{f.push({value:e("movie_hunt",p.name),label:`Movie Hunt - ${p.name}`,appType:"movie_hunt",name:p.name})}),g.forEach(p=>{f.push({value:e("radarr",p.name),label:`Radarr - ${p.name}`,appType:"radarr",name:p.name})}),f.length>0){s.innerHTML="",f.forEach(I=>{const M=document.createElement("option");M.value=I.value,M.textContent=I.label,s.appendChild(M)});const p=h.success&&h.defaults&&h.defaults.movie_instance;if(p){let I=!1;if(f.some(M=>M.value===p))s.value=p,I=!0;else{const M=f.find(w=>w.appType==="radarr"&&w.name===p);M&&(s.value=M.value,I=!0,v=!0)}I||(s.value=f[0].value,v=!0)}else s.value=f[0].value,v=!0}else s.innerHTML='<option value="">No movie instances configured</option>';if(c.instances&&c.instances.length>0){a.innerHTML="",c.instances.forEach(M=>{const w=document.createElement("option");w.value=M.name,w.textContent=`Sonarr - ${M.name}`,a.appendChild(w)});const p=h.success&&h.defaults&&h.defaults.tv_instance,I=p&&c.instances.some(M=>M.name===h.defaults.tv_instance);p&&I?a.value=h.defaults.tv_instance:(a.value=c.instances[0].name,v=!0)}else a.innerHTML='<option value="">No Sonarr instances configured</option>';f.length>0&&!s.value&&(s.value=f[0].value,v=!0),c.instances&&c.instances.length>0&&!a.value&&(a.value=c.instances[0].name,v=!0),v&&(console.log("[RequestarrSettings] Auto-saving first available instances as defaults"),await this.saveDefaultInstances(!0))}catch(n){console.error("[RequestarrDiscover] Error loading default instances:",n)}}async saveDefaultInstances(e=!1){const t=document.getElementById("default-movie-instance"),s=document.getElementById("default-tv-instance"),a=document.getElementById("save-default-instances");if(!(!t||!s)){a&&!e&&(a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{(await(await fetch("./api/requestarr/settings/default-instances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({movie_instance:t.value||"",tv_instance:s.value||""})})).json()).success?e||(this.core.showNotification("Default instances saved! Reloading discovery content...","success"),await this.loadDefaultRootFolders(),await new Promise(r=>setTimeout(r,1e3)),this.core.content.loadDiscoverContent()):e||this.core.showNotification("Failed to save default instances","error")}catch(n){console.error("[RequestarrDiscover] Error saving default instances:",n),e||this.core.showNotification("Failed to save default instances","error")}finally{a&&!e&&(a.disabled=!1,a.innerHTML='<i class="fas fa-save"></i> Save Default Instances')}}}async loadDefaultRootFolders(){const{decodeInstanceValue:e}=await Promise.resolve().then(()=>L),t=document.getElementById("default-root-folder-radarr"),s=document.getElementById("default-root-folder-sonarr"),a=document.getElementById("default-movie-instance"),n=document.getElementById("default-tv-instance");if(!(!t||!s)){if(this._loadingRootFolders){console.log("[RequestarrSettings] loadDefaultRootFolders already in progress, skipping");return}this._loadingRootFolders=!0;try{const i=await fetch("./api/requestarr/settings/default-instances"),r=await fetch("./api/requestarr/settings/default-root-folders"),o=await i.json(),l=r.ok?await r.json():{},d=a&&a.value||o.defaults&&o.defaults.movie_instance||"",c=n&&n.value||o.defaults&&o.defaults.tv_instance||"",m=e(d),h=m.appType,v=m.name,y=document.querySelector('label[for="default-root-folder-radarr"]');y&&(y.textContent=h==="movie_hunt"?"Default Root Folder (Movie Hunt)":"Default Root Folder (Radarr)");const g=h==="movie_hunt"?(l.default_root_folder_movie_hunt||"").trim():(l.default_root_folder_radarr||"").trim(),f=(l.default_root_folder_sonarr||"").trim(),p=h==="movie_hunt"?"Movie Hunt":"Radarr";if(v){const M=await(await fetch(`./api/requestarr/rootfolders?app_type=${h}&instance_name=${encodeURIComponent(v)}`)).json();if(console.log(`[RequestarrSettings] ${p} API returned`,M.root_folders?.length||0,"root folders"),M.success&&M.root_folders&&M.root_folders.length>0){const w=new Map;M.root_folders.forEach(E=>{if(!E||!E.path)return;const _=E.path.trim(),T=_.replace(/\/+$/,"").toLowerCase();T&&(w.has(T)||w.set(T,{path:_,freeSpace:E.freeSpace}))}),console.log(`[RequestarrSettings] After deduplication: ${w.size} unique ${p} root folders`),w.size===0?t.innerHTML=`<option value="">Use first root folder in ${p}</option>`:(t.innerHTML="",w.forEach(E=>{const _=document.createElement("option");_.value=E.path,_.textContent=E.path+(E.freeSpace!=null?` (${Math.round(E.freeSpace/1e9)} GB free)`:""),t.appendChild(_)}),g&&(t.value=g))}else t.innerHTML=`<option value="">Use first root folder in ${p}</option>`}else t.innerHTML=`<option value="">Use first root folder in ${p}</option>`;if(c){const M=await(await fetch(`./api/requestarr/rootfolders?app_type=sonarr&instance_name=${encodeURIComponent(c)}`)).json();if(console.log("[RequestarrSettings] Sonarr API returned",M.root_folders?.length||0,"root folders"),M.success&&M.root_folders&&M.root_folders.length>0){const w=new Map;M.root_folders.forEach(E=>{if(!E||!E.path)return;const _=E.path.trim(),T=_.replace(/\/+$/,"").toLowerCase();T&&(w.has(T)||w.set(T,{path:_,freeSpace:E.freeSpace}))}),console.log("[RequestarrSettings] After deduplication:",w.size,"unique Sonarr root folders"),w.size===0?s.innerHTML='<option value="">Use first root folder in Sonarr</option>':(s.innerHTML="",w.forEach(E=>{const _=document.createElement("option");_.value=E.path,_.textContent=E.path+(E.freeSpace!=null?` (${Math.round(E.freeSpace/1e9)} GB free)`:""),s.appendChild(_)}),f&&(s.value=f))}else s.innerHTML='<option value="">Use first root folder in Sonarr</option>'}else s.innerHTML='<option value="">Use first root folder in Sonarr</option>'}catch(i){console.error("[RequestarrSettings] Error loading default root folders:",i),t.innerHTML='<option value="">Use first root folder</option>',s.innerHTML='<option value="">Use first root folder in Sonarr</option>'}finally{this._loadingRootFolders=!1}}}async saveDefaultRootFolders(){const{decodeInstanceValue:e}=await Promise.resolve().then(()=>L),t=document.getElementById("default-root-folder-radarr"),s=document.getElementById("default-root-folder-sonarr"),a=document.getElementById("default-movie-instance"),n=document.getElementById("save-default-root-folders");if(!(!t||!s)){n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{const i=a?a.value:"",r=e(i),o={default_root_folder_sonarr:s.value||""};r.appType==="movie_hunt"?o.default_root_folder_movie_hunt=t.value||"":o.default_root_folder_radarr=t.value||"",(await(await fetch("./api/requestarr/settings/default-root-folders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()).success?this.core.showNotification("Default root folders saved.","success"):this.core.showNotification("Failed to save default root folders","error")}catch(i){console.error("[RequestarrSettings] Error saving default root folders:",i),this.core.showNotification("Failed to save default root folders","error")}finally{n&&(n.disabled=!1,n.innerHTML='<i class="fas fa-save"></i> Save Default Root Folders')}}}async loadDiscoverFilters(){const e=[{code:"",name:"All Regions",flag:"🌐"},{code:"AR",name:"Argentina",flag:"🇦🇷"},{code:"AU",name:"Australia",flag:"🇦🇺"},{code:"AT",name:"Austria",flag:"🇦🇹"},{code:"BE",name:"Belgium",flag:"🇧🇪"},{code:"BR",name:"Brazil",flag:"🇧🇷"},{code:"CA",name:"Canada",flag:"🇨🇦"},{code:"CL",name:"Chile",flag:"🇨🇱"},{code:"CN",name:"China",flag:"🇨🇳"},{code:"CO",name:"Colombia",flag:"🇨🇴"},{code:"CZ",name:"Czech Republic",flag:"🇨🇿"},{code:"DK",name:"Denmark",flag:"🇩🇰"},{code:"FI",name:"Finland",flag:"🇫🇮"},{code:"FR",name:"France",flag:"🇫🇷"},{code:"DE",name:"Germany",flag:"🇩🇪"},{code:"GR",name:"Greece",flag:"🇬🇷"},{code:"HK",name:"Hong Kong",flag:"🇭🇰"},{code:"HU",name:"Hungary",flag:"🇭🇺"},{code:"IS",name:"Iceland",flag:"🇮🇸"},{code:"IN",name:"India",flag:"🇮🇳"},{code:"ID",name:"Indonesia",flag:"🇮🇩"},{code:"IE",name:"Ireland",flag:"🇮🇪"},{code:"IL",name:"Israel",flag:"🇮🇱"},{code:"IT",name:"Italy",flag:"🇮🇹"},{code:"JP",name:"Japan",flag:"🇯🇵"},{code:"KR",name:"South Korea",flag:"🇰🇷"},{code:"MY",name:"Malaysia",flag:"🇲🇾"},{code:"MX",name:"Mexico",flag:"🇲🇽"},{code:"NL",name:"Netherlands",flag:"🇳🇱"},{code:"NZ",name:"New Zealand",flag:"🇳🇿"},{code:"NO",name:"Norway",flag:"🇳🇴"},{code:"PH",name:"Philippines",flag:"🇵🇭"},{code:"PL",name:"Poland",flag:"🇵🇱"},{code:"PT",name:"Portugal",flag:"🇵🇹"},{code:"RO",name:"Romania",flag:"🇷🇴"},{code:"RU",name:"Russia",flag:"🇷🇺"},{code:"SA",name:"Saudi Arabia",flag:"🇸🇦"},{code:"SG",name:"Singapore",flag:"🇸🇬"},{code:"ZA",name:"South Africa",flag:"🇿🇦"},{code:"ES",name:"Spain",flag:"🇪🇸"},{code:"SE",name:"Sweden",flag:"🇸🇪"},{code:"CH",name:"Switzerland",flag:"🇨🇭"},{code:"TW",name:"Taiwan",flag:"🇹🇼"},{code:"TH",name:"Thailand",flag:"🇹🇭"},{code:"TR",name:"Turkey",flag:"🇹🇷"},{code:"UA",name:"Ukraine",flag:"🇺🇦"},{code:"AE",name:"United Arab Emirates",flag:"🇦🇪"},{code:"GB",name:"United Kingdom",flag:"🇬🇧"},{code:"US",name:"United States",flag:"🇺🇸"}],t=e[0],s=e.slice(1).sort((a,n)=>a.name.localeCompare(n.name));this.regions=[t,...s],this.selectedRegion="US",this.initializeRegionSelect(),this.initializeLanguageSelect(),this.initializeProviderSelect();try{const n=await(await fetch("./api/requestarr/settings/filters")).json();n.success&&n.filters?(n.filters.region!==void 0&&(this.selectedRegion=n.filters.region,this.updateRegionDisplay()),n.filters.languages&&n.filters.languages.length>0?this.selectedLanguages=n.filters.languages:this.selectedLanguages=[],this.renderLanguageTags(),n.filters.providers&&n.filters.providers.length>0?this.selectedProviders=n.filters.providers:this.selectedProviders=[]):(this.selectedRegion="US",this.updateRegionDisplay(),this.selectedLanguages=[],this.renderLanguageTags(),this.selectedProviders=[])}catch(a){console.error("[RequestarrDiscover] Error loading discover filters:",a),this.selectedRegion="US",this.updateRegionDisplay(),this.selectedLanguages=[],this.renderLanguageTags(),this.selectedProviders=[]}await this.loadProviders(this.selectedRegion)}initializeRegionSelect(){const e=document.getElementById("region-select-display"),t=document.getElementById("region-dropdown"),s=document.getElementById("region-list");!e||!t||!s||this.regionSelectInitialized||(this.renderRegionList(),e.onclick=a=>{a.stopPropagation(),a.preventDefault(),t.style.display==="none"||!t.style.display?(t.style.display="block",e.classList.add("open")):(t.style.display="none",e.classList.remove("open"))},t.onclick=a=>{a.stopPropagation()},document.addEventListener("click",a=>{!e.contains(a.target)&&!t.contains(a.target)&&(t.style.display="none",e.classList.remove("open"))}),this.regionSelectInitialized=!0)}renderRegionList(e=""){const t=document.getElementById("region-list");if(!t)return;const s=this.regions.filter(a=>a.name.toLowerCase().includes(e));t.innerHTML="",s.forEach(a=>{const n=document.createElement("div");n.className="custom-select-option",n.textContent=`${a.flag} ${a.name}`,n.dataset.code=a.code,this.selectedRegion===a.code&&n.classList.add("selected"),n.onclick=i=>{i.stopPropagation(),this.selectedRegion=a.code,this.updateRegionDisplay(),this.renderRegionList(),document.getElementById("region-dropdown").style.display="none",document.getElementById("region-select-display").classList.remove("open"),this.handleRegionChange()},t.appendChild(n)})}updateRegionDisplay(){const e=document.getElementById("region-selected-text");if(!e)return;const t=this.regions.find(s=>s.code===this.selectedRegion);t&&(e.textContent=`${t.flag} ${t.name}`)}initializeLanguageSelect(){const e=document.getElementById("discover-language"),t=document.getElementById("language-dropdown"),s=document.getElementById("language-list");!e||!t||!s||this.languageSelectInitialized||(this.selectedLanguages=this.selectedLanguages||[],this.languages=[{code:"ar",name:"Arabic"},{code:"zh",name:"Chinese"},{code:"da",name:"Danish"},{code:"nl",name:"Dutch"},{code:"en",name:"English"},{code:"fi",name:"Finnish"},{code:"fr",name:"French"},{code:"de",name:"German"},{code:"hi",name:"Hindi"},{code:"it",name:"Italian"},{code:"ja",name:"Japanese"},{code:"ko",name:"Korean"},{code:"no",name:"Norwegian"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"ru",name:"Russian"},{code:"es",name:"Spanish"},{code:"sv",name:"Swedish"},{code:"th",name:"Thai"},{code:"tr",name:"Turkish"}],this.renderLanguageList(),e.onclick=a=>{a.stopPropagation();const n=t.style.display==="block";t.style.display=n?"none":"block"},document.addEventListener("click",a=>{!t.contains(a.target)&&a.target!==e&&(t.style.display="none")}),this.languageSelectInitialized=!0)}initializeProviderSelect(){const e=document.getElementById("discover-providers"),t=document.getElementById("provider-dropdown"),s=document.getElementById("provider-list");!e||!t||!s||this.providerSelectInitialized||(this.selectedProviders=this.selectedProviders||[],this.providers=this.providers||[],this.renderProviderList(),this.renderProviderTags(),e.onclick=a=>{a.stopPropagation();const n=t.style.display==="block";t.style.display=n?"none":"block"},document.addEventListener("click",a=>{!t.contains(a.target)&&a.target!==e&&(t.style.display="none")}),this.providerSelectInitialized=!0)}renderLanguageList(e=""){const t=document.getElementById("language-list");if(!t)return;t.innerHTML="";const s=e.trim().toLowerCase();if(!s||"all languages".includes(s)){const n=document.createElement("div");n.className="language-item",n.textContent="All Languages",n.dataset.code="",this.selectedLanguages.length===0&&n.classList.add("selected"),n.addEventListener("click",()=>{this.selectedLanguages=[],this.renderLanguageTags(),this.renderLanguageList(e);const i=document.getElementById("language-dropdown");i&&(i.style.display="none")}),t.appendChild(n)}this.languages.forEach(n=>{if(s&&!n.name.toLowerCase().includes(s))return;const i=document.createElement("div");i.className="language-item",i.textContent=n.name,i.dataset.code=n.code,this.selectedLanguages.includes(n.code)&&i.classList.add("selected"),i.addEventListener("click",()=>{const r=i.dataset.code,o=this.selectedLanguages.indexOf(r);o>-1?(this.selectedLanguages.splice(o,1),i.classList.remove("selected")):(this.selectedLanguages.push(r),i.classList.add("selected")),this.renderLanguageTags();const l=document.getElementById("language-dropdown");l&&(l.style.display="none")}),t.appendChild(i)})}renderLanguageTags(){const e=document.getElementById("language-tags");if(e){if(e.innerHTML="",this.selectedLanguages.length===0){const t=document.createElement("div");t.className="language-tag",t.innerHTML="All Languages",t.style.cursor="default",e.appendChild(t);return}this.selectedLanguages.forEach(t=>{const s=this.languages.find(n=>n.code===t);if(!s)return;const a=document.createElement("div");a.className="language-tag",a.innerHTML=`
                ${s.name}
                <span class="language-tag-remove" data-code="${t}">×</span>
            `,a.querySelector(".language-tag-remove").addEventListener("click",n=>{n.stopPropagation();const i=n.target.dataset.code;this.selectedLanguages=this.selectedLanguages.filter(r=>r!==i),this.renderLanguageTags(),this.renderLanguageList()}),e.appendChild(a)})}}async loadProviders(e){try{const s=await(await fetch(`./api/requestarr/watch-providers/movie?region=${encodeURIComponent(e||"")}`)).json();this.providers=s.providers||[];const a=new Set(this.providers.map(n=>String(n.provider_id)));this.selectedProviders=(this.selectedProviders||[]).filter(n=>a.has(n))}catch(t){console.error("[RequestarrDiscover] Error loading watch providers:",t),this.providers=[]}this.renderProviderList(),this.renderProviderTags()}renderProviderList(){const e=document.getElementById("provider-list");if(e){if(e.innerHTML="",!this.providers||this.providers.length===0){e.innerHTML='<div class="language-item" style="color: #888;">No providers found</div>';return}this.providers.forEach(t=>{const s=String(t.provider_id),a=document.createElement("div");a.className="language-item",a.textContent=t.provider_name,a.dataset.code=s,this.selectedProviders.includes(s)&&a.classList.add("selected"),a.addEventListener("click",()=>{const n=a.dataset.code,i=this.selectedProviders.indexOf(n);i>-1?(this.selectedProviders.splice(i,1),a.classList.remove("selected")):(this.selectedProviders.push(n),a.classList.add("selected")),this.renderProviderTags();const r=document.getElementById("provider-dropdown");r&&(r.style.display="none")}),e.appendChild(a)})}}renderProviderTags(){const e=document.getElementById("provider-tags");if(e){if(e.innerHTML="",!this.selectedProviders||this.selectedProviders.length===0){const t=document.createElement("div");t.className="language-tag",t.innerHTML="All Providers",t.style.cursor="default",e.appendChild(t);return}this.selectedProviders.forEach(t=>{const s=(this.providers||[]).find(n=>String(n.provider_id)===t);if(!s)return;const a=document.createElement("div");a.className="language-tag",a.innerHTML=`
                ${s.provider_name}
                <span class="language-tag-remove" data-code="${t}">×</span>
            `,a.querySelector(".language-tag-remove").addEventListener("click",n=>{n.stopPropagation();const i=n.target.dataset.code;this.selectedProviders=this.selectedProviders.filter(r=>r!==i),this.renderProviderTags(),this.renderProviderList()}),e.appendChild(a)})}}handleRegionChange(){this.selectedProviders=[],this.renderProviderTags(),this.renderProviderList(),this.loadProviders(this.selectedRegion)}async saveDiscoverFilters(e=!1){const t=document.getElementById("save-discover-filters");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{(await(await fetch("./api/requestarr/settings/filters",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({region:this.selectedRegion||"",languages:this.selectedLanguages||[],providers:this.selectedProviders||[]})})).json()).success?(e||this.core.showNotification("Filters saved! Reloading discover content...","success"),setTimeout(()=>{this.core.content.loadDiscoverContent()},500)):this.core.showNotification("Failed to save discover filters","error")}catch(s){console.error("[RequestarrDiscover] Error saving discover filters:",s),this.core.showNotification("Failed to save discover filters","error")}finally{t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save"></i> Save Filters')}}async loadSmartHuntSettings(){try{const t=await(await fetch("./api/requestarr/settings/smarthunt")).json();if(!t.success||!t.settings)return;const s=t.settings,a=document.getElementById("smarthunt-hide-library");a&&(a.checked=s.hide_library_items!==!1);const n=document.getElementById("smarthunt-cache-ttl");n&&(n.value=String(s.cache_ttl_minutes??60));const i=document.getElementById("smarthunt-min-rating");i&&(i.value=s.min_tmdb_rating??6);const r=document.getElementById("smarthunt-min-votes");r&&(r.value=s.min_vote_count??50);const o=document.getElementById("smarthunt-year-start");o&&(o.value=s.year_start??2e3);const l=document.getElementById("smarthunt-year-end");l&&(l.value=s.year_end??new Date().getFullYear()+1);const d=s.percentages||{};["similar_library","trending","hidden_gems","new_releases","top_rated","genre_mix","upcoming","random"].forEach(m=>{const h=document.getElementById(`smarthunt-pct-${m}`);h&&(h.value=d[m]??0)}),this._updateSmartHuntTotal(),this._wireSmartHuntEvents()}catch(e){console.error("[SmartHuntSettings] Error loading:",e)}}_wireSmartHuntEvents(){if(this._smarthuntEventsWired)return;this._smarthuntEventsWired=!0,document.querySelectorAll(".smarthunt-pct").forEach(t=>{t.addEventListener("input",()=>this._updateSmartHuntTotal())});const e=document.getElementById("smarthunt-save-btn");e&&e.addEventListener("click",()=>this.saveSmartHuntSettings())}_updateSmartHuntTotal(){const e=["similar_library","trending","hidden_gems","new_releases","top_rated","genre_mix","upcoming","random"];let t=0;e.forEach(n=>{const i=document.getElementById(`smarthunt-pct-${n}`);i&&(t+=parseInt(i.value)||0)});const s=document.getElementById("smarthunt-total-value"),a=document.getElementById("smarthunt-total-bar");s&&(s.textContent=t),a&&(a.classList.toggle("is-valid",t===100),a.classList.toggle("is-invalid",t!==100))}async saveSmartHuntSettings(){const e=document.getElementById("smarthunt-save-btn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...');try{const t=["similar_library","trending","hidden_gems","new_releases","top_rated","genre_mix","upcoming","random"],s={};let a=0;if(t.forEach(o=>{const l=document.getElementById(`smarthunt-pct-${o}`),d=parseInt(l?.value)||0;s[o]=d,a+=d}),a!==100){const o=100-a+(s.random||0);if(o>=0&&o<=100){s.random=o;const l=document.getElementById("smarthunt-pct-random");l&&(l.value=o)}else{const l=100/(a||1);let d=0;t.forEach((c,m)=>{m<t.length-1?(s[c]=Math.round(s[c]*l),d+=s[c]):s[c]=100-d}),t.forEach(c=>{const m=document.getElementById(`smarthunt-pct-${c}`);m&&(m.value=s[c])})}this._updateSmartHuntTotal()}const n={enabled:!0,cache_ttl_minutes:parseInt(document.getElementById("smarthunt-cache-ttl")?.value)||60,hide_library_items:document.getElementById("smarthunt-hide-library")?.checked??!0,min_tmdb_rating:parseFloat(document.getElementById("smarthunt-min-rating")?.value)||6,min_vote_count:parseInt(document.getElementById("smarthunt-min-votes")?.value)||0,year_start:parseInt(document.getElementById("smarthunt-year-start")?.value)||2e3,year_end:parseInt(document.getElementById("smarthunt-year-end")?.value)||new Date().getFullYear()+1,percentages:s};(await(await fetch("./api/requestarr/settings/smarthunt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json()).success?(this.core.showNotification("Smart Hunt settings saved successfully","success"),window.invalidateSmartHuntCache&&window.invalidateSmartHuntCache()):this.core.showNotification("Failed to save Smart Hunt settings","error")}catch(t){console.error("[SmartHuntSettings] Error saving:",t),this.core.showNotification("Failed to save Smart Hunt settings","error")}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Save')}}}class D{constructor(e){this.core=e;const t=new Date().getFullYear();this.maxYear=t+3,this.minYear=1900,this.activeFilters={genres:[],yearMin:this.minYear,yearMax:this.maxYear,runtimeMin:0,runtimeMax:400,ratingMin:0,ratingMax:10,votesMin:0,votesMax:1e4,hideAvailable:!1},this.genres=[],this.init()}init(){this.loadGenres(),this.setupYearRangeSlider(),this.setupEventListeners(),this.updateFilterDisplay()}setupYearRangeSlider(){const e=document.getElementById("filter-year-min"),t=document.getElementById("filter-year-max");e&&t&&(e.max=this.maxYear,e.value=this.minYear,t.max=this.maxYear,t.value=this.maxYear,this.updateYearDisplay(),this.updateSliderRange("year",e,t))}async loadGenres(){try{const[e,t]=await Promise.all([fetch("./api/requestarr/genres/movie"),fetch("./api/requestarr/settings/blacklisted-genres")]),s=await e.json(),n=((await t.json()).blacklisted_movie_genres||[]).map(i=>parseInt(i,10));s.genres&&(this.genres=s.genres.filter(i=>!n.includes(i.id)),this.populateGenresSelect())}catch(e){console.error("[RequestarrFilters] Error loading genres:",e),this.genres=[{id:28,name:"Action"},{id:12,name:"Adventure"},{id:16,name:"Animation"},{id:35,name:"Comedy"},{id:80,name:"Crime"},{id:99,name:"Documentary"},{id:18,name:"Drama"},{id:10751,name:"Family"},{id:14,name:"Fantasy"},{id:36,name:"History"},{id:27,name:"Horror"},{id:10402,name:"Music"},{id:9648,name:"Mystery"},{id:10749,name:"Romance"},{id:878,name:"Science Fiction"},{id:10770,name:"TV Movie"},{id:53,name:"Thriller"},{id:10752,name:"War"},{id:37,name:"Western"}],this.populateGenresSelect()}}populateGenresSelect(){const e=document.getElementById("genre-list");e&&(e.innerHTML="",this.genres.forEach(t=>{const s=document.createElement("div");s.className="genre-item",s.textContent=t.name,s.dataset.genreId=t.id,this.activeFilters.genres.includes(t.id)&&s.classList.add("selected"),s.addEventListener("click",()=>{const a=parseInt(s.dataset.genreId),n=this.activeFilters.genres.indexOf(a);n>-1?(this.activeFilters.genres.splice(n,1),s.classList.remove("selected")):(this.activeFilters.genres.push(a),s.classList.add("selected")),this.renderSelectedGenres(),this.updateModalFilterCount(),this.autoApplyFilters();const i=document.getElementById("genre-dropdown");i&&(i.style.display="none")}),e.appendChild(s)}))}renderSelectedGenres(){const e=document.getElementById("selected-genres");if(e){if(e.innerHTML="",this.activeFilters.genres.length===0){e.style.display="none";return}e.style.display="flex",this.activeFilters.genres.forEach(t=>{const s=this.genres.find(r=>r.id===t);if(!s)return;const a=document.createElement("div");a.className="selected-genre-pill";const n=document.createElement("span");n.textContent=s.name;const i=document.createElement("span");i.className="remove-genre",i.innerHTML="×",i.addEventListener("click",r=>{r.stopPropagation();const o=this.activeFilters.genres.indexOf(t);o>-1&&this.activeFilters.genres.splice(o,1),this.renderSelectedGenres(),this.updateModalFilterCount(),this.autoApplyFilters(),document.querySelectorAll(".genre-item").forEach(d=>{parseInt(d.dataset.genreId)===t&&d.classList.remove("selected")})}),a.appendChild(n),a.appendChild(i),e.appendChild(a)})}}setupEventListeners(){const e=document.getElementById("movies-filter-btn");e&&e.addEventListener("click",()=>this.openFiltersModal());const t=document.getElementById("movies-sort");t&&t.addEventListener("change",v=>{this.applySortChange(v.target.value)});const s=document.getElementById("hide-available-movies");s&&s.addEventListener("change",v=>{this.activeFilters.hideAvailable=v.target.checked,this.updateModalFilterCount(),this.autoApplyFilters()});const a=document.getElementById("genre-search-input"),n=document.getElementById("genre-dropdown");a&&n&&(a.addEventListener("click",v=>{v.stopPropagation();const y=n.style.display==="block";n.style.display=y?"none":"block"}),document.addEventListener("click",v=>{!n.contains(v.target)&&v.target!==a&&(n.style.display="none")}),n.addEventListener("click",v=>{v.stopPropagation()}));const i=document.getElementById("filter-year-min"),r=document.getElementById("filter-year-max");i&&r&&(i.addEventListener("input",()=>{parseInt(i.value)>parseInt(r.value)&&(i.value=r.value),this.updateYearDisplay(),this.updateSliderRange("year",i,r),this.updateModalFilterCount()}),i.addEventListener("change",()=>{this.autoApplyFilters()}),r.addEventListener("input",()=>{parseInt(r.value)<parseInt(i.value)&&(r.value=i.value),this.updateYearDisplay(),this.updateSliderRange("year",i,r),this.updateModalFilterCount()}),r.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("year",i,r));const o=document.getElementById("filter-runtime-min"),l=document.getElementById("filter-runtime-max");o&&l&&(o.addEventListener("input",()=>{parseInt(o.value)>parseInt(l.value)&&(o.value=l.value),this.updateRuntimeDisplay(),this.updateSliderRange("runtime",o,l),this.updateModalFilterCount()}),o.addEventListener("change",()=>{this.autoApplyFilters()}),l.addEventListener("input",()=>{parseInt(l.value)<parseInt(o.value)&&(l.value=o.value),this.updateRuntimeDisplay(),this.updateSliderRange("runtime",o,l),this.updateModalFilterCount()}),l.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("runtime",o,l));const d=document.getElementById("filter-rating-min"),c=document.getElementById("filter-rating-max");d&&c&&(d.addEventListener("input",()=>{parseFloat(d.value)>parseFloat(c.value)&&(d.value=c.value),this.updateRatingDisplay(),this.updateSliderRange("rating",d,c),this.updateModalFilterCount()}),d.addEventListener("change",()=>{this.autoApplyFilters()}),c.addEventListener("input",()=>{parseFloat(c.value)<parseFloat(d.value)&&(c.value=d.value),this.updateRatingDisplay(),this.updateSliderRange("rating",d,c),this.updateModalFilterCount()}),c.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("rating",d,c));const m=document.getElementById("filter-votes-min"),h=document.getElementById("filter-votes-max");m&&h&&(m.addEventListener("input",()=>{parseInt(m.value)>parseInt(h.value)&&(m.value=h.value),this.updateVotesDisplay(),this.updateSliderRange("votes",m,h),this.updateModalFilterCount()}),m.addEventListener("change",()=>{this.autoApplyFilters()}),h.addEventListener("input",()=>{parseInt(h.value)<parseInt(m.value)&&(h.value=m.value),this.updateVotesDisplay(),this.updateSliderRange("votes",m,h),this.updateModalFilterCount()}),h.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("votes",m,h))}updateSliderRange(e,t,s){const a=document.getElementById(`${e}-range`);if(!a)return;const n=parseFloat(t.value),i=parseFloat(s.value),r=parseFloat(t.min),o=parseFloat(t.max),l=(n-r)/(o-r)*100,d=(i-r)/(o-r)*100;a.style.left=l+"%",a.style.width=d-l+"%"}updateYearDisplay(){const e=document.getElementById("filter-year-min"),t=document.getElementById("filter-year-max");let s=parseInt(e.value),a=parseInt(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("year-display");n&&(n.textContent=`Movies from ${s} to ${a}`)}updateRuntimeDisplay(){const e=document.getElementById("filter-runtime-min"),t=document.getElementById("filter-runtime-max");let s=parseInt(e.value),a=parseInt(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("runtime-display");n&&(n.textContent=`${s}-${a} minute runtime`)}updateRatingDisplay(){const e=document.getElementById("filter-rating-min"),t=document.getElementById("filter-rating-max");let s=parseFloat(e.value),a=parseFloat(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("rating-display");n&&(n.textContent=`Ratings between ${s.toFixed(1)} and ${a.toFixed(1)}`)}updateVotesDisplay(){const e=document.getElementById("filter-votes-min"),t=document.getElementById("filter-votes-max");let s=parseInt(e.value),a=parseInt(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("votes-display");n&&(n.textContent=`Number of votes between ${s} and ${a}`)}openFiltersModal(){const e=document.getElementById("movies-filter-modal");e&&(this.loadFilterValues(),e.style.display="flex",setTimeout(()=>e.classList.add("show"),10),document.body.style.overflow="hidden")}closeFiltersModal(){const e=document.getElementById("movies-filter-modal");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none",document.body.style.overflow=""},150))}loadFilterValues(){document.getElementById("filter-year-min").value=this.activeFilters.yearMin,document.getElementById("filter-year-max").value=this.activeFilters.yearMax,document.getElementById("filter-runtime-min").value=this.activeFilters.runtimeMin,document.getElementById("filter-runtime-max").value=this.activeFilters.runtimeMax,document.getElementById("filter-rating-min").value=this.activeFilters.ratingMin,document.getElementById("filter-rating-max").value=this.activeFilters.ratingMax,document.getElementById("filter-votes-min").value=this.activeFilters.votesMin,document.getElementById("filter-votes-max").value=this.activeFilters.votesMax,document.getElementById("hide-available-movies").checked=this.activeFilters.hideAvailable,this.renderSelectedGenres(),document.querySelectorAll(".genre-item").forEach(t=>{const s=parseInt(t.dataset.genreId);this.activeFilters.genres.includes(s)?t.classList.add("selected"):t.classList.remove("selected")}),this.updateYearDisplay(),this.updateRuntimeDisplay(),this.updateRatingDisplay(),this.updateVotesDisplay(),this.updateModalFilterCount()}autoApplyFilters(){let e=parseInt(document.getElementById("filter-year-min")?.value||this.minYear),t=parseInt(document.getElementById("filter-year-max")?.value||this.maxYear),s=parseInt(document.getElementById("filter-runtime-min")?.value||0),a=parseInt(document.getElementById("filter-runtime-max")?.value||400),n=parseFloat(document.getElementById("filter-rating-min")?.value||0),i=parseFloat(document.getElementById("filter-rating-max")?.value||10),r=parseInt(document.getElementById("filter-votes-min")?.value||0),o=parseInt(document.getElementById("filter-votes-max")?.value||1e4);e>t&&([e,t]=[t,e]),s>a&&([s,a]=[a,s]),n>i&&([n,i]=[i,n]),r>o&&([r,o]=[o,r]),this.activeFilters.yearMin=e,this.activeFilters.yearMax=t,this.activeFilters.runtimeMin=s,this.activeFilters.runtimeMax=a,this.activeFilters.ratingMin=n,this.activeFilters.ratingMax=i,this.activeFilters.votesMin=r,this.activeFilters.votesMax=o,this.updateFilterDisplay(),this.core.content.moviesPage=1,this.core.content.moviesHasMore=!0,this.core.content.loadMovies()}applyFilters(){let e=parseInt(document.getElementById("filter-year-min").value),t=parseInt(document.getElementById("filter-year-max").value),s=parseInt(document.getElementById("filter-runtime-min").value),a=parseInt(document.getElementById("filter-runtime-max").value),n=parseFloat(document.getElementById("filter-rating-min").value),i=parseFloat(document.getElementById("filter-rating-max").value),r=parseInt(document.getElementById("filter-votes-min").value),o=parseInt(document.getElementById("filter-votes-max").value);e>t&&([e,t]=[t,e]),s>a&&([s,a]=[a,s]),n>i&&([n,i]=[i,n]),r>o&&([r,o]=[o,r]),this.activeFilters.yearMin=e,this.activeFilters.yearMax=t,this.activeFilters.runtimeMin=s,this.activeFilters.runtimeMax=a,this.activeFilters.ratingMin=n,this.activeFilters.ratingMax=i,this.activeFilters.votesMin=r,this.activeFilters.votesMax=o,this.updateFilterDisplay(),this.closeFiltersModal(),this.core.content.moviesPage=1,this.core.content.moviesHasMore=!0,this.core.content.loadMovies()}clearFilters(){this.activeFilters={genres:[],yearMin:this.minYear,yearMax:this.maxYear,runtimeMin:0,runtimeMax:400,ratingMin:0,ratingMax:10,votesMin:0,votesMax:1e4,hideAvailable:!1};const e=document.getElementById("movies-sort");e&&(e.value="popularity.desc"),this.updateFilterDisplay(),this.loadFilterValues(),this.closeFiltersModal(),this.core.content.moviesPage=1,this.core.content.moviesHasMore=!0,this.core.content.loadMovies()}updateFilterDisplay(){let e=0;this.activeFilters.genres.length>0&&e++,(this.activeFilters.yearMin>this.minYear||this.activeFilters.yearMax<this.maxYear)&&e++,(this.activeFilters.runtimeMin>0||this.activeFilters.runtimeMax<400)&&e++,(this.activeFilters.ratingMin>0||this.activeFilters.ratingMax<10)&&e++,(this.activeFilters.votesMin>0||this.activeFilters.votesMax<1e4)&&e++,this.activeFilters.hideAvailable&&e++;const t=document.getElementById("movies-filter-count"),s=e===0?"0 Active Filters":e===1?"1 Active Filter":`${e} Active Filters`;t&&(t.textContent=s),this.updateModalFilterCount()}updateModalFilterCount(){let e=0;document.querySelectorAll(".filter-genre-item.selected").length>0&&e++;const s=parseInt(document.getElementById("filter-year-min")?.value||this.minYear),a=parseInt(document.getElementById("filter-year-max")?.value||this.maxYear);(s>this.minYear||a<this.maxYear)&&e++;const n=parseInt(document.getElementById("filter-runtime-min")?.value||0),i=parseInt(document.getElementById("filter-runtime-max")?.value||400);(n>0||i<400)&&e++;const r=parseFloat(document.getElementById("filter-rating-min")?.value||0),o=parseFloat(document.getElementById("filter-rating-max")?.value||10);(r>0||o<10)&&e++;const l=parseInt(document.getElementById("filter-votes-min")?.value||0),d=parseInt(document.getElementById("filter-votes-max")?.value||1e4);(l>0||d<1e4)&&e++,(document.getElementById("hide-available-movies")?.checked||!1)&&e++;const m=document.getElementById("filter-active-count"),h=e===0?"0 Active Filters":e===1?"1 Active Filter":`${e} Active Filters`;m&&(m.textContent=h)}applySortChange(e){this.core.content.moviesPage=1,this.core.content.moviesHasMore=!0,this.core.content.loadMovies()}getFilterParams(){const e=new URLSearchParams,t=document.getElementById("movies-sort");return t&&t.value?e.append("sort_by",t.value):e.append("sort_by","popularity.desc"),this.activeFilters.genres.length>0&&e.append("with_genres",this.activeFilters.genres.join(",")),this.activeFilters.yearMin>this.minYear&&e.append("release_date.gte",`${this.activeFilters.yearMin}-01-01`),this.activeFilters.yearMax<this.maxYear&&e.append("release_date.lte",`${this.activeFilters.yearMax}-12-31`),(this.activeFilters.runtimeMin>0||this.activeFilters.runtimeMax<400)&&(e.append("with_runtime.gte",this.activeFilters.runtimeMin),e.append("with_runtime.lte",this.activeFilters.runtimeMax)),(this.activeFilters.ratingMin>0||this.activeFilters.ratingMax<10)&&(e.append("vote_average.gte",this.activeFilters.ratingMin),e.append("vote_average.lte",this.activeFilters.ratingMax)),(this.activeFilters.votesMin>0||this.activeFilters.votesMax<1e4)&&(e.append("vote_count.gte",this.activeFilters.votesMin),e.append("vote_count.lte",this.activeFilters.votesMax)),this.activeFilters.hideAvailable&&e.append("hide_available","true"),e.toString()}}class k{constructor(e){this.core=e;const t=new Date().getFullYear();this.maxYear=t+3,this.minYear=1900,this.activeFilters={genres:[],yearMin:this.minYear,yearMax:this.maxYear,ratingMin:0,ratingMax:10,votesMin:0,votesMax:1e4,hideAvailable:!1},this.genres=[],this.init()}init(){this.loadGenres(),this.setupYearRangeSlider(),this.setupEventListeners(),this.updateFilterDisplay()}setupYearRangeSlider(){const e=document.getElementById("tv-filter-year-min"),t=document.getElementById("tv-filter-year-max");e&&t&&(e.max=this.maxYear,e.value=this.minYear,t.max=this.maxYear,t.value=this.maxYear,this.updateYearDisplay(),this.updateSliderRange("tv-year",e,t))}async loadGenres(){try{const[e,t]=await Promise.all([fetch("./api/requestarr/genres/tv"),fetch("./api/requestarr/settings/blacklisted-genres")]),s=await e.json(),n=((await t.json()).blacklisted_tv_genres||[]).map(i=>parseInt(i,10));s.genres&&(this.genres=s.genres.filter(i=>!n.includes(parseInt(i.id,10))),this.populateGenresSelect())}catch(e){console.error("[RequestarrTVFilters] Error loading genres:",e),this.genres=[{id:10759,name:"Action & Adventure"},{id:16,name:"Animation"},{id:35,name:"Comedy"},{id:80,name:"Crime"},{id:99,name:"Documentary"},{id:18,name:"Drama"},{id:10751,name:"Family"},{id:10762,name:"Kids"},{id:9648,name:"Mystery"},{id:10763,name:"News"},{id:10764,name:"Reality"},{id:10765,name:"Sci-Fi & Fantasy"},{id:10766,name:"Soap"},{id:10767,name:"Talk"},{id:10768,name:"War & Politics"},{id:37,name:"Western"}],this.populateGenresSelect()}}populateGenresSelect(){const e=document.getElementById("tv-genre-list");e&&(e.innerHTML="",this.genres.forEach(t=>{const s=document.createElement("div");s.className="genre-item",s.textContent=t.name,s.dataset.genreId=t.id,this.activeFilters.genres.includes(t.id)&&s.classList.add("selected"),s.addEventListener("click",()=>{const a=parseInt(s.dataset.genreId),n=this.activeFilters.genres.indexOf(a);n>-1?(this.activeFilters.genres.splice(n,1),s.classList.remove("selected")):(this.activeFilters.genres.push(a),s.classList.add("selected")),this.renderSelectedGenres(),this.updateModalFilterCount(),this.autoApplyFilters();const i=document.getElementById("tv-genre-dropdown");i&&(i.style.display="none")}),e.appendChild(s)}))}renderSelectedGenres(){const e=document.getElementById("tv-selected-genres");if(e){if(e.innerHTML="",this.activeFilters.genres.length===0){e.style.display="none";return}e.style.display="flex",this.activeFilters.genres.forEach(t=>{const s=this.genres.find(r=>r.id===t);if(!s)return;const a=document.createElement("div");a.className="selected-genre-pill";const n=document.createElement("span");n.textContent=s.name;const i=document.createElement("span");i.className="remove-genre",i.innerHTML="×",i.addEventListener("click",r=>{r.stopPropagation();const o=this.activeFilters.genres.indexOf(t);o>-1&&this.activeFilters.genres.splice(o,1),this.renderSelectedGenres(),this.updateModalFilterCount(),this.autoApplyFilters(),document.querySelectorAll("#tv-genre-list .genre-item").forEach(d=>{parseInt(d.dataset.genreId)===t&&d.classList.remove("selected")})}),a.appendChild(n),a.appendChild(i),e.appendChild(a)})}}setupEventListeners(){const e=document.getElementById("tv-filter-btn");e&&e.addEventListener("click",()=>this.openFiltersModal());const t=document.getElementById("tv-sort");t&&t.addEventListener("change",m=>{this.applySortChange(m.target.value)});const s=document.getElementById("hide-available-tv");s&&s.addEventListener("change",m=>{this.activeFilters.hideAvailable=m.target.checked,this.updateModalFilterCount(),this.autoApplyFilters()});const a=document.getElementById("tv-genre-search-input"),n=document.getElementById("tv-genre-dropdown");a&&n&&(a.addEventListener("click",m=>{m.stopPropagation();const h=n.style.display==="block";n.style.display=h?"none":"block"}),document.addEventListener("click",m=>{!n.contains(m.target)&&m.target!==a&&(n.style.display="none")}),n.addEventListener("click",m=>{m.stopPropagation()}));const i=document.getElementById("tv-filter-year-min"),r=document.getElementById("tv-filter-year-max");i&&r&&(i.addEventListener("input",()=>{parseInt(i.value)>parseInt(r.value)&&(i.value=r.value),this.updateYearDisplay(),this.updateSliderRange("tv-year",i,r),this.updateModalFilterCount()}),i.addEventListener("change",()=>{this.autoApplyFilters()}),r.addEventListener("input",()=>{parseInt(r.value)<parseInt(i.value)&&(r.value=i.value),this.updateYearDisplay(),this.updateSliderRange("tv-year",i,r),this.updateModalFilterCount()}),r.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("tv-year",i,r));const o=document.getElementById("tv-filter-rating-min"),l=document.getElementById("tv-filter-rating-max");o&&l&&(o.addEventListener("input",()=>{parseFloat(o.value)>parseFloat(l.value)&&(o.value=l.value),this.updateRatingDisplay(),this.updateSliderRange("tv-rating",o,l),this.updateModalFilterCount()}),o.addEventListener("change",()=>{this.autoApplyFilters()}),l.addEventListener("input",()=>{parseFloat(l.value)<parseFloat(o.value)&&(l.value=o.value),this.updateRatingDisplay(),this.updateSliderRange("tv-rating",o,l),this.updateModalFilterCount()}),l.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("tv-rating",o,l));const d=document.getElementById("tv-filter-votes-min"),c=document.getElementById("tv-filter-votes-max");d&&c&&(d.addEventListener("input",()=>{parseInt(d.value)>parseInt(c.value)&&(d.value=c.value),this.updateVotesDisplay(),this.updateSliderRange("tv-votes",d,c),this.updateModalFilterCount()}),d.addEventListener("change",()=>{this.autoApplyFilters()}),c.addEventListener("input",()=>{parseInt(c.value)<parseInt(d.value)&&(c.value=d.value),this.updateVotesDisplay(),this.updateSliderRange("tv-votes",d,c),this.updateModalFilterCount()}),c.addEventListener("change",()=>{this.autoApplyFilters()}),this.updateSliderRange("tv-votes",d,c))}updateSliderRange(e,t,s){const a=document.getElementById(`${e}-range`);if(!a)return;const n=parseFloat(t.value),i=parseFloat(s.value),r=parseFloat(t.min),o=parseFloat(t.max),l=(n-r)/(o-r)*100,d=(i-r)/(o-r)*100;a.style.left=l+"%",a.style.width=d-l+"%"}updateYearDisplay(){const e=document.getElementById("tv-filter-year-min"),t=document.getElementById("tv-filter-year-max");let s=parseInt(e.value),a=parseInt(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("tv-year-display");n&&(n.textContent=`TV shows from ${s} to ${a}`)}updateRatingDisplay(){const e=document.getElementById("tv-filter-rating-min"),t=document.getElementById("tv-filter-rating-max");let s=parseFloat(e.value),a=parseFloat(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("tv-rating-display");n&&(n.textContent=`Ratings between ${s.toFixed(1)} and ${a.toFixed(1)}`)}updateVotesDisplay(){const e=document.getElementById("tv-filter-votes-min"),t=document.getElementById("tv-filter-votes-max");let s=parseInt(e.value),a=parseInt(t.value);if(s>a){const i=s;s=a,a=i}const n=document.getElementById("tv-votes-display");n&&(n.textContent=`Number of votes between ${s} and ${a}`)}openFiltersModal(){const e=document.getElementById("tv-filter-modal");e&&(this.loadFilterValues(),e.style.display="flex",setTimeout(()=>e.classList.add("show"),10),document.body.style.overflow="hidden")}closeFiltersModal(){const e=document.getElementById("tv-filter-modal");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none",document.body.style.overflow=""},150))}loadFilterValues(){document.getElementById("tv-filter-year-min").value=this.activeFilters.yearMin,document.getElementById("tv-filter-year-max").value=this.activeFilters.yearMax,document.getElementById("tv-filter-rating-min").value=this.activeFilters.ratingMin,document.getElementById("tv-filter-rating-max").value=this.activeFilters.ratingMax,document.getElementById("tv-filter-votes-min").value=this.activeFilters.votesMin,document.getElementById("tv-filter-votes-max").value=this.activeFilters.votesMax,document.getElementById("hide-available-tv").checked=this.activeFilters.hideAvailable,this.renderSelectedGenres(),document.querySelectorAll("#tv-genre-list .genre-item").forEach(t=>{const s=parseInt(t.dataset.genreId);this.activeFilters.genres.includes(s)?t.classList.add("selected"):t.classList.remove("selected")}),this.updateYearDisplay(),this.updateRatingDisplay(),this.updateVotesDisplay(),this.updateModalFilterCount()}autoApplyFilters(){let e=parseInt(document.getElementById("tv-filter-year-min")?.value||this.minYear),t=parseInt(document.getElementById("tv-filter-year-max")?.value||this.maxYear),s=parseFloat(document.getElementById("tv-filter-rating-min")?.value||0),a=parseFloat(document.getElementById("tv-filter-rating-max")?.value||10),n=parseInt(document.getElementById("tv-filter-votes-min")?.value||0),i=parseInt(document.getElementById("tv-filter-votes-max")?.value||1e4);e>t&&([e,t]=[t,e]),s>a&&([s,a]=[a,s]),n>i&&([n,i]=[i,n]),this.activeFilters.yearMin=e,this.activeFilters.yearMax=t,this.activeFilters.ratingMin=s,this.activeFilters.ratingMax=a,this.activeFilters.votesMin=n,this.activeFilters.votesMax=i,this.updateFilterDisplay(),this.core.content.tvPage=1,this.core.content.tvHasMore=!0,this.core.content.loadTV()}applyFilters(){let e=parseInt(document.getElementById("tv-filter-year-min").value),t=parseInt(document.getElementById("tv-filter-year-max").value),s=parseFloat(document.getElementById("tv-filter-rating-min").value),a=parseFloat(document.getElementById("tv-filter-rating-max").value),n=parseInt(document.getElementById("tv-filter-votes-min").value),i=parseInt(document.getElementById("tv-filter-votes-max").value);e>t&&([e,t]=[t,e]),s>a&&([s,a]=[a,s]),n>i&&([n,i]=[i,n]),this.activeFilters.yearMin=e,this.activeFilters.yearMax=t,this.activeFilters.ratingMin=s,this.activeFilters.ratingMax=a,this.activeFilters.votesMin=n,this.activeFilters.votesMax=i,this.updateFilterDisplay(),this.closeFiltersModal(),this.core.content.tvPage=1,this.core.content.tvHasMore=!0,this.core.content.loadTV()}clearFilters(){this.activeFilters={genres:[],yearMin:this.minYear,yearMax:this.maxYear,ratingMin:0,ratingMax:10,votesMin:0,votesMax:1e4,hideAvailable:!1};const e=document.getElementById("tv-sort");e&&(e.value="popularity.desc"),this.updateFilterDisplay(),this.loadFilterValues(),this.closeFiltersModal(),this.core.content.tvPage=1,this.core.content.tvHasMore=!0,this.core.content.loadTV()}updateFilterDisplay(){let e=0;this.activeFilters.genres.length>0&&e++,(this.activeFilters.yearMin>this.minYear||this.activeFilters.yearMax<this.maxYear)&&e++,(this.activeFilters.ratingMin>0||this.activeFilters.ratingMax<10)&&e++,(this.activeFilters.votesMin>0||this.activeFilters.votesMax<1e4)&&e++,this.activeFilters.hideAvailable&&e++;const t=document.getElementById("tv-filter-count"),s=e===0?"0 Active Filters":e===1?"1 Active Filter":`${e} Active Filters`;t&&(t.textContent=s),this.updateModalFilterCount()}updateModalFilterCount(){let e=0;document.querySelectorAll("#tv-genre-list .genre-item.selected").length>0&&e++;const s=parseInt(document.getElementById("tv-filter-year-min")?.value||this.minYear),a=parseInt(document.getElementById("tv-filter-year-max")?.value||this.maxYear);(s>this.minYear||a<this.maxYear)&&e++;const n=parseFloat(document.getElementById("tv-filter-rating-min")?.value||0),i=parseFloat(document.getElementById("tv-filter-rating-max")?.value||10);(n>0||i<10)&&e++;const r=parseInt(document.getElementById("tv-filter-votes-min")?.value||0),o=parseInt(document.getElementById("tv-filter-votes-max")?.value||1e4);(r>0||o<1e4)&&e++,(document.getElementById("hide-available-tv")?.checked||!1)&&e++;const d=document.getElementById("tv-filter-active-count"),c=e===0?"0 Active Filters":e===1?"1 Active Filter":`${e} Active Filters`;d&&(d.textContent=c)}applySortChange(e){this.core.content.tvPage=1,this.core.content.tvHasMore=!0,this.core.content.loadTV()}getFilterParams(){const e=new URLSearchParams,t=document.getElementById("tv-sort");return t&&t.value?e.append("sort_by",t.value):e.append("sort_by","popularity.desc"),this.activeFilters.genres.length>0&&e.append("with_genres",this.activeFilters.genres.join(",")),this.activeFilters.yearMin>this.minYear&&e.append("first_air_date.gte",`${this.activeFilters.yearMin}-01-01`),this.activeFilters.yearMax<this.maxYear&&e.append("first_air_date.lte",`${this.activeFilters.yearMax}-12-31`),(this.activeFilters.ratingMin>0||this.activeFilters.ratingMax<10)&&(e.append("vote_average.gte",this.activeFilters.ratingMin),e.append("vote_average.lte",this.activeFilters.ratingMax)),(this.activeFilters.votesMin>0||this.activeFilters.votesMax<1e4)&&(e.append("vote_count.gte",this.activeFilters.votesMin),e.append("vote_count.lte",this.activeFilters.votesMax)),this.activeFilters.hideAvailable&&e.append("hide_available","true"),e.toString()}}function S(u,e){return`${u}:${e}`}function b(u){if(!u)return{appType:"radarr",name:""};const e=u.indexOf(":");return e===-1?{appType:"radarr",name:u}:{appType:u.substring(0,e),name:u.substring(e+1)}}class q{constructor(){this.currentView="discover",this.instances={sonarr:[],radarr:[],movie_hunt:[]},this.qualityProfiles={},this.searchTimeouts={},this.currentModal=null,this.currentModalData=null,this.content=new x(this),this.search=new C(this),this.modal=new F(this),this.settings=new H(this),this.filters=new D(this),this.tvFilters=new k(this),this.init()}init(){this.loadInstances(),this.setupCarouselArrows(),this.search.setupGlobalSearch(),this.content.loadDiscoverContent()}async loadInstances(){try{const e=Date.now(),s=await(await fetch(`./api/requestarr/instances?t=${e}`,{cache:"no-store"})).json();(s.sonarr||s.radarr||s.movie_hunt)&&(this.instances={sonarr:s.sonarr||[],radarr:s.radarr||[],movie_hunt:s.movie_hunt||[]},await this.loadAllQualityProfiles())}catch(e){console.error("[RequestarrDiscover] Error loading instances:",e)}}async loadAllQualityProfiles(){for(const e of this.instances.radarr)await this.loadQualityProfilesForInstance("radarr",e.name);for(const e of this.instances.sonarr)await this.loadQualityProfilesForInstance("sonarr",e.name);for(const e of this.instances.movie_hunt)await this.loadQualityProfilesForInstance("movie_hunt",e.name)}async loadQualityProfilesForInstance(e,t){try{const a=await(await fetch(`./api/requestarr/quality-profiles/${e}/${encodeURIComponent(t)}`)).json();if(a.success)return this.qualityProfiles[`${e}-${t}`]=a.profiles,a.profiles}catch(s){console.error(`[RequestarrDiscover] Error loading quality profiles for ${e}/${t}:`,s)}return[]}switchView(e){console.log(`[RequestarrDiscover] switchView called with: ${e}`);const t=document.getElementById("global-search-input");t&&(t.value="");let s=null;t?s=t.closest(".global-search-bar"):s=document.querySelector("#requestarr-section .global-search-bar"),s?(console.log(`[RequestarrDiscover] Found global search bar, applying visibility for ${e}`),e==="hidden"||e==="settings"||e==="smarthunt-settings"?(s.style.setProperty("display","none","important"),console.log("[RequestarrDiscover] Hiding global search bar")):(s.style.setProperty("display","flex","important"),console.log("[RequestarrDiscover] Showing global search bar"))):console.error("[RequestarrDiscover] Global search bar not found!");const a=document.getElementById("search-results-view");a&&(a.style.display="none"),document.querySelectorAll(".requestarr-view").forEach(i=>{i.classList.remove("active"),i.style.display="none"});const n=document.getElementById(`requestarr-${e}-view`);switch(n&&(n.classList.add("active"),n.style.display="block"),this.currentView=e,e){case"discover":document.getElementById("trending-carousel").children.length||this.content.loadDiscoverContent();break;case"movies":this.content.selectedMovieInstance?(this.content.moviesPage=1,this.content.moviesHasMore=!0,this.content.loadMovies(),this.content.setupMoviesInfiniteScroll()):this.content.setupInstanceSelectors().then(()=>{this.content.moviesPage=1,this.content.moviesHasMore=!0,this.content.loadMovies(),this.content.setupMoviesInfiniteScroll()});break;case"tv":this.content.selectedTVInstance?(this.content.tvPage=1,this.content.tvHasMore=!0,this.content.loadTV(),this.content.setupTVInfiniteScroll()):this.content.setupInstanceSelectors().then(()=>{this.content.tvPage=1,this.content.tvHasMore=!0,this.content.loadTV(),this.content.setupTVInfiniteScroll()});break;case"hidden":this.settings.loadHiddenMedia();break;case"settings":this.settings.loadSettings();break;case"smarthunt-settings":this.settings.loadSmartHuntSettings();break}}setupCarouselArrows(){const e=document.querySelectorAll(".carousel-arrow"),t=new Set,s={};e.forEach(a=>{const n=a.dataset.target,i=document.getElementById(n);i&&t.add(i)}),t.forEach(a=>{const n=()=>{const r=a.id,o=document.querySelector(`.carousel-arrow.left[data-target="${r}"]`),l=document.querySelector(`.carousel-arrow.right[data-target="${r}"]`);if(!o||!l)return;const d=a.scrollLeft,c=a.scrollWidth-a.clientWidth,m=d<=5,h=c>5&&d>=c-5;m||(s[r]=!0),m&&!s[r]?(o.style.opacity="0",o.style.pointerEvents="none"):(o.style.opacity="0.8",o.style.pointerEvents="auto"),h?(l.style.opacity="0",l.style.pointerEvents="none"):(l.style.opacity="0.8",l.style.pointerEvents="auto")};a.addEventListener("scroll",n),setTimeout(()=>n(),100),window.addEventListener("resize",n),new MutationObserver(()=>{n()}).observe(a,{childList:!0,subtree:!0})}),e.forEach(a=>{a.addEventListener("click",n=>{const i=a.dataset.target,r=document.getElementById(i),o=r.offsetWidth,c=150+20,h=Math.floor(o/c)*c;a.classList.contains("left")?r.scrollBy({left:-h,behavior:"smooth"}):r.scrollBy({left:h,behavior:"smooth"})})})}closeFiltersModal(){this.filters&&this.filters.closeFiltersModal()}closeTVFiltersModal(){this.tvFilters&&this.tvFilters.closeFiltersModal()}applyFilters(){this.filters&&this.filters.applyFilters()}clearFilters(){this.filters&&this.filters.clearFilters()}showNotification(e,t="info"){const s=document.createElement("div");s.className=`requestarr-notification ${t}`,s.innerHTML=`
            <i class="fas fa-${t==="success"?"check-circle":t==="error"?"exclamation-circle":"info-circle"}"></i>
            <span>${e}</span>
        `,document.body.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),s.classList.add("slideOut"),setTimeout(()=>s.remove(),300)},4e3)}}const L=Object.freeze(Object.defineProperty({__proto__:null,RequestarrDiscover:q,decodeInstanceValue:b,encodeInstanceValue:S},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",()=>{window.RequestarrDiscover=new q,console.log("[RequestarrController] Discover modules loaded successfully")}),window.HuntarrRequestarr={runWhenRequestarrReady:function(u,e){if(window.RequestarrDiscover){e();return}const t=Date.now(),s=setInterval(()=>{if(window.RequestarrDiscover){clearInterval(s),e();return}Date.now()-t>2e3&&(clearInterval(s),console.warn(`[HuntarrRequestarr] RequestarrDiscover not ready for ${u} after 2s`))},50)},showRequestarrSidebar:function(){const u=document.getElementById("sidebar"),e=document.getElementById("requestarr-sidebar"),t=document.getElementById("settings-sidebar"),s=document.getElementById("apps-sidebar");u&&(u.style.display="none"),t&&(t.style.display="none"),s&&(s.style.display="none"),e&&(e.style.display="block"),this.updateRequestarrSidebarActive()},showRequestarrView:function(u){const e=document.getElementById("requestarr-home-view");e&&(e.style.display=u==="home"?"block":"none"),this.updateRequestarrNavigation(u)},updateRequestarrSidebarActive:function(){if(!window.huntarrUI)return;const u=window.huntarrUI.currentSection;document.querySelectorAll("#requestarr-sidebar .nav-item").forEach(t=>{t.classList.remove("active");const s=t.querySelector("a");s&&s.getAttribute("href")===`#${u}`&&t.classList.add("active")})},updateRequestarrNavigation:function(u){window.RequestarrDiscover&&typeof window.RequestarrDiscover.switchView=="function"&&window.RequestarrDiscover.switchView(u)},setupRequestarrNavigation:function(){document.querySelectorAll("#requestarr-sidebar .nav-item a").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.getAttribute("href");s&&(window.location.hash=s)})})}};const $={core:null,searchTimeout:null,elements:{},defaultMovieInstance:null,defaultTVInstance:null,showTrending:!0,_smartHunt:null,_encodeInstance(u,e){return`${u}:${e}`},_decodeInstance(u){if(!u||!u.includes(":"))return{appType:"radarr",name:u||""};const e=u.indexOf(":");return{appType:u.substring(0,e),name:u.substring(e+1)}},init(){this.cacheElements(),this.elements.searchInput&&(window.HomeRequestarr=this,document.addEventListener("huntarr:instances-changed",()=>{this._populateInstanceDropdowns()}),this.elements.discoverView&&this.elements.discoverView.style.setProperty("display","none","important"),this.loadSettings().then(()=>{if(this.applyTrendingVisibility(),!this.showTrending){this.setupSearch();return}this.waitForCore().then(u=>{this.core=u,this.setupSearch(),this.loadDefaultInstances().then(()=>{this._initSmartHunt()})}).catch(()=>{console.warn("[HomeRequestarr] Requestarr modules not ready within timeout")})}))},refresh(){this.loadSettings().then(()=>{this.applyTrendingVisibility(),this.showTrending&&(this._smartHunt?this.loadDefaultInstances().then(()=>{this._smartHunt.reload()}):this.waitForCore().then(u=>{this.core=u,this.loadDefaultInstances().then(()=>{this._initSmartHunt()})}).catch(()=>{console.warn("[HomeRequestarr] Could not init SmartHunt on refresh")}))})},_initSmartHunt(){const u=document.getElementById("home-smarthunt-section");if(u&&(u.style.display="block"),!window.SmartHunt){console.warn("[HomeRequestarr] SmartHunt class not available yet");return}const e=this;this._smartHunt=new window.SmartHunt({carouselId:"home-smarthunt-carousel",core:this.core,getMovieInstance:()=>e.defaultMovieInstance||"",getTVInstance:()=>e.defaultTVInstance||""}),this._smartHunt.load()},async loadSettings(){try{const e=await(await fetch("./api/settings")).json();e&&e.general&&(this.showTrending=e.general.show_trending!==!1,console.log("[HomeRequestarr] Show Smart Hunt on Home:",this.showTrending))}catch(u){console.error("[HomeRequestarr] Error loading settings:",u),this.enableRequestarr=!0,this.showTrending=!0}},applyTrendingVisibility(){const u=this.elements.discoverView;u&&(this.showTrending?u.style.setProperty("display","block","important"):u.style.setProperty("display","none","important"))},cacheElements(){this.elements.searchInput=document.getElementById("home-requestarr-search-input"),this.elements.searchResultsView=document.getElementById("home-search-results-view"),this.elements.searchResultsGrid=document.getElementById("home-search-results-grid"),this.elements.discoverView=document.getElementById("home-requestarr-discover-view"),this.elements.smarthuntCarousel=document.getElementById("home-smarthunt-carousel"),this.elements.instanceControls=document.getElementById("home-instance-controls"),this.elements.movieInstanceSelect=document.getElementById("home-movie-instance-select"),this.elements.tvInstanceSelect=document.getElementById("home-tv-instance-select")},waitForCore(){return new Promise((u,e)=>{if(window.RequestarrDiscover){u(window.RequestarrDiscover);return}const t=Date.now(),s=setInterval(()=>{if(window.RequestarrDiscover){clearInterval(s),u(window.RequestarrDiscover);return}Date.now()-t>2e3&&(clearInterval(s),e(new Error("RequestarrDiscover not ready")))},50)})},async loadDefaultInstances(){try{const e=await(await fetch("./api/requestarr/settings/default-instances")).json();e.success&&e.defaults&&(this.defaultMovieInstance=e.defaults.movie_instance||null,this.defaultTVInstance=e.defaults.tv_instance||null)}catch(u){console.error("[HomeRequestarr] Error loading default instances:",u),this.defaultMovieInstance=null,this.defaultTVInstance=null}await this._populateInstanceDropdowns()},async _populateInstanceDropdowns(){await Promise.all([this._populateMovieInstanceDropdown(),this._populateTVInstanceDropdown()]),this.elements.instanceControls&&(this.elements.instanceControls.style.display="flex")},async _populateMovieInstanceDropdown(){const u=this.elements.movieInstanceSelect;if(u)try{const e=Date.now(),[t,s]=await Promise.all([fetch(`./api/requestarr/instances/movie_hunt?t=${e}`,{cache:"no-store"}),fetch(`./api/requestarr/instances/radarr?t=${e}`,{cache:"no-store"})]),a=await t.json(),n=await s.json(),i=[...(a.instances||[]).map(o=>({name:String(o.name).trim(),appType:"movie_hunt",label:`Movie Hunt – ${String(o.name).trim()}`})),...(n.instances||[]).map(o=>({name:String(o.name).trim(),appType:"radarr",label:`Radarr – ${String(o.name).trim()}`}))],r=this.defaultMovieInstance||u.value||"";if(u.innerHTML="",i.length===0){u.innerHTML='<option value="">No movie instances</option>';return}i.forEach(o=>{const l=this._encodeInstance(o.appType,o.name),d=document.createElement("option");d.value=l,d.textContent=o.label,r&&(l===r||o.name===r)&&(d.selected=!0),u.appendChild(d)}),u.value&&(this.defaultMovieInstance=u.value),u._homeChangeWired||(u._homeChangeWired=!0,u.addEventListener("change",async()=>{this.defaultMovieInstance=u.value,await this._saveServerDefaults(),this._syncRequestarrContent(),this._smartHunt&&this._smartHunt.reload()}))}catch(e){console.error("[HomeRequestarr] Error populating movie instances:",e)}},async _populateTVInstanceDropdown(){const u=this.elements.tvInstanceSelect;if(u)try{const s=((await(await fetch(`./api/requestarr/instances/sonarr?t=${Date.now()}`,{cache:"no-store"})).json()).instances||[]).map(n=>({name:String(n.name).trim()})),a=this.defaultTVInstance||u.value||"";if(u.innerHTML="",s.length===0){u.innerHTML='<option value="">No TV instances</option>';return}s.forEach(n=>{const i=document.createElement("option");i.value=n.name,i.textContent=`Sonarr – ${n.name}`,a&&n.name===a&&(i.selected=!0),u.appendChild(i)}),u.value&&(this.defaultTVInstance=u.value),u._homeChangeWired||(u._homeChangeWired=!0,u.addEventListener("change",async()=>{this.defaultTVInstance=u.value,await this._saveServerDefaults(),this._syncRequestarrContent(),this._smartHunt&&this._smartHunt.reload()}))}catch(e){console.error("[HomeRequestarr] Error populating TV instances:",e)}},_saveServerDefaults(){return fetch("./api/requestarr/settings/default-instances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({movie_instance:this.defaultMovieInstance||"",tv_instance:this.defaultTVInstance||""})}).catch(u=>console.warn("[HomeRequestarr] Failed to save defaults:",u))},_syncRequestarrContent(){this.core&&this.core.content&&(this.core.content.selectedMovieInstance=this.defaultMovieInstance,this.core.content.selectedTVInstance=this.defaultTVInstance,["movies-instance-select","discover-movie-instance-select"].forEach(u=>{const e=document.getElementById(u);e&&e.value!==this.defaultMovieInstance&&(e.value=this.defaultMovieInstance)}),["tv-instance-select","discover-tv-instance-select"].forEach(u=>{const e=document.getElementById(u);e&&e.value!==this.defaultTVInstance&&(e.value=this.defaultTVInstance)}))},setupSearch(){this.elements.searchInput.addEventListener("input",u=>{this.handleSearch(u.target.value)})},handleSearch(u){if(this.enableRequestarr){if(this.searchTimeout&&clearTimeout(this.searchTimeout),!u.trim()){this.showDiscover();return}this.searchTimeout=setTimeout(()=>{this.performSearch(u)},500)}},showDiscover(){this.elements.searchResultsView&&(this.elements.searchResultsView.style.display="none"),this.elements.discoverView&&(this.showTrending?this.elements.discoverView.style.setProperty("display","block","important"):this.elements.discoverView.style.setProperty("display","none","important"))},showResults(){this.elements.discoverView&&(this.elements.discoverView.style.display="none"),this.elements.searchResultsView&&(this.elements.searchResultsView.style.display="block")},async performSearch(u){if(this.enableRequestarr&&(this.showResults(),!!this.elements.searchResultsGrid)){this.elements.searchResultsGrid.innerHTML='<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Searching...</p></div>';try{const e=this._decodeInstance(this.defaultMovieInstance),t=this.defaultTVInstance||"",[s,a]=await Promise.all([fetch(`./api/requestarr/search?q=${encodeURIComponent(u)}&app_type=${encodeURIComponent(e.appType)}&instance_name=${encodeURIComponent(e.name)}`),fetch(`./api/requestarr/search?q=${encodeURIComponent(u)}&app_type=sonarr&instance_name=${encodeURIComponent(t)}`)]),n=await s.json(),i=await a.json(),r=[...n.results||[],...i.results||[]];r.sort((o,l)=>(l.popularity||0)-(o.popularity||0)),r.length>0?(this.elements.searchResultsGrid.innerHTML="",r.forEach(o=>{const l=o.media_type==="movie"?this.defaultMovieInstance:this.defaultTVInstance,d=this.createMediaCard(o,l);d&&this.elements.searchResultsGrid.appendChild(d)})):this.elements.searchResultsGrid.innerHTML='<p style="color: #888; text-align: center; padding: 60px; width: 100%;">No results found</p>'}catch(e){console.error("[HomeRequestarr] Error searching:",e),this.elements.searchResultsGrid.innerHTML='<p style="color: #ef4444; text-align: center; padding: 60px; width: 100%;">Search failed</p>'}}},createMediaCard(u,e=null){return!this.core||!this.core.content||typeof this.core.content.createMediaCard!="function"?null:this.core.content.createMediaCard(u,e)}};document.addEventListener("DOMContentLoaded",()=>{$.init()})})();
