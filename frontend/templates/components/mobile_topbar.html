<!-- Mobile Navigation — Topbar + Slide-out Drawer -->

<!-- ===== MOBILE TOPBAR ===== -->
<div id="mobile-topbar" class="mtb">
    <div class="mtb-inner">
        <!-- Left: Hamburger + Logo + Title -->
        <div class="mtb-left">
            <button class="mtb-hamburger" id="mobileMenuToggle" aria-label="Open menu">
                <span></span><span></span><span></span>
            </button>
            <a href="#home" class="mtb-logo-link">
                <img src="./static/logo/32.png" alt="Huntarr" class="mtb-logo" width="28" height="28">
            </a>
            <span class="mtb-title" id="mobilePageTitle">Home</span>
        </div>

        <!-- Right: Stars + Version + Discord + Reddit + Heart -->
        <div class="mtb-right">
            <a href="https://github.com/plexguide/huntarr" target="_blank" rel="noopener"
               class="mtb-chip mtb-chip-stars" title="GitHub Stars">
                <i class="fas fa-star"></i>
                <span id="mtb-stars">--</span>
            </a>
            <div class="mtb-chip mtb-chip-version" title="Current version">
                <i class="fas fa-code-branch"></i>
                <span id="mtb-version">--</span>
            </div>
            <a href="https://discord.com/invite/PGJJjR5Cww" target="_blank" rel="noopener"
               class="mtb-icon-btn mtb-discord" title="Join Discord" aria-label="Discord">
                <i class="fab fa-discord"></i>
            </a>
            <a href="https://www.reddit.com/r/huntarr/" target="_blank" rel="noopener"
               class="mtb-icon-btn mtb-reddit" title="Visit Reddit" aria-label="Reddit">
                <i class="fab fa-reddit-alien"></i>
            </a>
            <a href="https://plexguide.github.io/Huntarr.io/donate.html" target="_blank" rel="noopener noreferrer"
               class="mtb-icon-btn mtb-heart" title="Become a Sponsor" aria-label="Donate">
                <i class="fas fa-heart"></i>
            </a>
        </div>
    </div>
    <div class="mtb-accent"></div>
</div>

<!-- ===== MOBILE DRAWER (slide-out, content built dynamically) ===== -->
<div class="mdrawer-backdrop" id="mobileDrawerBackdrop"></div>
<nav class="mdrawer" id="mobileDrawer" aria-label="Mobile navigation">
    <div class="mdrawer-header">
        <img src="./static/logo/32.png" alt="Huntarr" class="mdrawer-logo" width="28" height="28">
        <span class="mdrawer-brand">Huntarr</span>
        <button class="mdrawer-close" id="mobileMenuClose" aria-label="Close menu">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <!-- Dynamic body — populated from the active desktop sidebar -->
    <div class="mdrawer-body" id="mobileDrawerBody"></div>
    <div class="mdrawer-footer">
        <a href="https://plexguide.github.io/Huntarr.io/donate.html" target="_blank" rel="noopener noreferrer" class="mdrawer-donate">
            <i class="fas fa-heart"></i><span>Become a Sponsor</span>
        </a>
        <div class="mdrawer-version-row" id="mobileDrawerVersionRow">
            <span class="mdrawer-ver-current" id="mobileDrawerVersion">--</span>
            <span class="mdrawer-ver-latest" id="mobileDrawerLatest"></span>
        </div>
    </div>
</nav>

<script>
(function() {
    /* ---- helpers ---- */
    var SIDEBAR_IDS = ['sidebar', 'movie-hunt-sidebar', 'nzb-hunt-sidebar',
                       'requestarr-sidebar', 'apps-sidebar', 'settings-sidebar'];

    /** Find which desktop sidebar is currently "active" (display != none). */
    function getActiveSidebar() {
        for (var i = 0; i < SIDEBAR_IDS.length; i++) {
            var el = document.getElementById(SIDEBAR_IDS[i]);
            if (el) {
                var d = el.style.display;
                if (SIDEBAR_IDS[i] === 'sidebar' && (d === '' || d === 'block' || d === 'flex')) return el;
                if (d === 'block' || d === 'flex') return el;
            }
        }
        return document.getElementById('sidebar');
    }

    /** Build mobile drawer content from the given desktop sidebar element. */
    function buildDrawerContent(sidebar) {
        var body = document.getElementById('mobileDrawerBody');
        if (!body || !sidebar) return;
        body.innerHTML = '';

        var groups = sidebar.querySelectorAll('.nav-group');
        groups.forEach(function(desktopGroup) {
            if (desktopGroup.style.display === 'none') return;

            var mGroup = document.createElement('div');
            mGroup.className = 'mdrawer-group';

            var titleEl = desktopGroup.querySelector('.nav-group-title');
            if (titleEl) {
                var mTitle = document.createElement('div');
                mTitle.className = 'mdrawer-group-title';
                mTitle.textContent = titleEl.textContent;
                mGroup.appendChild(mTitle);
            }

            var items = desktopGroup.querySelectorAll(':scope > a.nav-item');
            items.forEach(function(navItem) {
                if (navItem.style.display === 'none') return;
                if (navItem.querySelector('.heart-icon')) return;
                appendDrawerItem(mGroup, navItem);
            });

            var subGroups = desktopGroup.querySelectorAll('.nav-sub-group');
            subGroups.forEach(function(sub) {
                var isExpanded = sub.classList.contains('expanded') || sub.style.display === 'block';
                if (!isExpanded) return;
                var subItems = sub.querySelectorAll('a.nav-item');
                subItems.forEach(function(navItem) {
                    if (navItem.style.display === 'none') return;
                    appendDrawerItem(mGroup, navItem, true);
                });
            });

            if (mGroup.querySelectorAll('.mdrawer-item').length > 0) {
                body.appendChild(mGroup);
            }
        });

        body.querySelectorAll('.mdrawer-item').forEach(function(item) {
            item.addEventListener('click', shut);
        });
        highlightActiveItem();
    }

    /** Create a single drawer nav item from a desktop sidebar nav-item <a>. */
    function appendDrawerItem(parent, navItem, isSub) {
        var a = document.createElement('a');
        var href = navItem.getAttribute('href') || '#home';
        if (href.indexOf('./') === 0) href = href.substring(1);
        if (href.indexOf('/#') === 0) href = href.substring(1);
        if (href.indexOf('http') === 0) return;
        a.href = href;
        a.className = 'mdrawer-item' + (isSub ? ' mdrawer-item-sub' : '');

        var iconImg = navItem.querySelector('.app-icon-img');
        var iconI = navItem.querySelector('.nav-icon-wrapper i');
        if (iconImg) {
            var img = document.createElement('img');
            img.src = iconImg.src;
            img.alt = iconImg.alt || '';
            img.className = 'mdrawer-app-icon';
            img.width = 20; img.height = 20;
            a.appendChild(img);
        } else if (iconI) {
            var i = document.createElement('i');
            i.className = iconI.className;
            a.appendChild(i);
        }

        var label = navItem.querySelector('span');
        if (label) {
            var s = document.createElement('span');
            s.textContent = label.textContent;
            a.appendChild(s);
        }
        parent.appendChild(a);
    }

    /** Highlight the drawer item matching the current hash. */
    function highlightActiveItem() {
        var body = document.getElementById('mobileDrawerBody');
        if (!body) return;
        var hash = window.location.hash || '#home';
        body.querySelectorAll('.mdrawer-item').forEach(function(item) {
            item.classList.toggle('active', item.getAttribute('href') === hash);
        });
    }

    /* ---- open / close ---- */
    var drawer, backdrop;

    function open() {
        if (!drawer) return;
        buildDrawerContent(getActiveSidebar());
        drawer.classList.add('open');
        backdrop.classList.add('open');
        document.body.classList.add('mdrawer-open');
    }
    function shut() {
        if (!drawer) return;
        drawer.classList.remove('open');
        backdrop.classList.remove('open');
        document.body.classList.remove('mdrawer-open');
    }

    /* ---- version + stars (topbar chips & drawer footer) ---- */
    function updateVersionUI() {
        try {
            var info = JSON.parse(localStorage.getItem('huntarr-version-info') || '{}');
            var stars = localStorage.getItem('huntarr-github-stars');

            // Topbar chips
            var mtbVer = document.getElementById('mtb-version');
            if (mtbVer && info.currentVersion) mtbVer.textContent = 'v' + info.currentVersion;

            var mtbStars = document.getElementById('mtb-stars');
            if (mtbStars && stars) {
                try {
                    var p = JSON.parse(stars);
                    mtbStars.textContent = (p && p.stars !== undefined) ? Number(p.stars).toLocaleString() : stars;
                } catch(e) { mtbStars.textContent = stars; }
            }

            // Drawer footer — current version
            var dvCur = document.getElementById('mobileDrawerVersion');
            if (dvCur && info.currentVersion) dvCur.textContent = 'v' + info.currentVersion;

            // Drawer footer — latest version + update hint
            var dvLatest = document.getElementById('mobileDrawerLatest');
            if (dvLatest && info.latestVersion) {
                var isNewer = info.latestVersion !== info.currentVersion;
                if (isNewer) {
                    dvLatest.innerHTML = '<i class="fas fa-arrow-circle-up"></i> v' + info.latestVersion + ' available';
                    dvLatest.className = 'mdrawer-ver-latest mdrawer-update-available';
                } else {
                    dvLatest.innerHTML = '<i class="fas fa-check-circle"></i> Up to date';
                    dvLatest.className = 'mdrawer-ver-latest mdrawer-up-to-date';
                }
            }
        } catch(e) {}
    }

    /* ---- init ---- */
    function initMobileNav() {
        drawer   = document.getElementById('mobileDrawer');
        backdrop = document.getElementById('mobileDrawerBackdrop');
        var toggle = document.getElementById('mobileMenuToggle');
        var close  = document.getElementById('mobileMenuClose');
        if (!toggle || !drawer) return;

        toggle.addEventListener('click', open);
        close.addEventListener('click', shut);
        backdrop.addEventListener('click', shut);
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && drawer.classList.contains('open')) shut();
        });

        updateVersionUI();
        window.addEventListener('storage', function(e) {
            if (e.key === 'huntarr-version-info' || e.key === 'huntarr-github-stars') updateVersionUI();
        });
        // Also poll once after a delay (version info may load asynchronously)
        setTimeout(updateVersionUI, 3000);
    }

    /* ---- page title sync ---- */
    function updateMobilePageTitle(title) {
        var el = document.getElementById('mobilePageTitle');
        if (el) el.textContent = title || 'Home';
    }
    window.updateMobilePageTitle = updateMobilePageTitle;
    // Expose version update for external callers
    window.updateMobileVersionUI = updateVersionUI;

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMobileNav();
            var pt = document.getElementById('currentPageTitle');
            if (pt) updateMobilePageTitle(pt.textContent);
            var obs = new MutationObserver(function() {
                var pt2 = document.getElementById('currentPageTitle');
                if (pt2) updateMobilePageTitle(pt2.textContent);
            });
            if (pt) obs.observe(pt, { childList: true, characterData: true, subtree: true });
        });
    } else {
        initMobileNav();
    }
})();
</script>
