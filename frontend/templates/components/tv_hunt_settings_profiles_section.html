<section id="tvHuntSettingsProfilesSection" class="content-section" style="display: none;">
    {% with section_id='tv-hunt-settings-profiles' %}{% include 'components/sponsor_banners_partial.html' %}{% endwith %}
    <div class="app-content-panel" style="width:100%;padding:20px;margin:0;background:transparent;box-shadow:none;border:none;">
        <div class="movie-hunt-settings-instance-bar" style="margin-bottom: 16px;">
            <select id="tv-hunt-settings-profiles-instance-select" class="control-select" aria-label="Instance">
                <option value="">Loading...</option>
            </select>
        </div>
        <div class="settings-group profiles-settings-group" style="background:rgba(15,23,42,0.4);border:1px solid rgba(148,163,184,0.08);border-radius:12px;padding:24px;margin:12px 0 20px 0;">
            <h3 class="profiles-settings-group-h3" style="margin:0 0 18px 0;padding:0 0 12px 0;font-size:1.1rem;font-weight:600;color:#f1f5f9;border-bottom:1px solid rgba(148,163,184,0.12);">Profiles</h3>
            <div class="instance-card-grid" id="tv-hunt-profile-instances-grid">
                <div class="add-instance-card" data-app-type="tv-hunt-profile">
                    <div class="add-icon"><i class="fas fa-plus-circle"></i></div>
                    <div class="add-text">Add Profile</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Profile modal (TV Hunt) -->
    <div id="tv-hunt-profile-add-modal" class="profile-add-modal" style="display: none;">
        <div class="profile-add-modal-backdrop" id="tv-hunt-profile-add-modal-backdrop"></div>
        <div class="profile-add-modal-content">
            <div class="profile-add-modal-header">
                <button type="button" class="profile-add-modal-close" id="tv-hunt-profile-add-modal-close" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="profile-add-modal-title">Add Profile</h2>
                <p class="profile-add-modal-subtitle">Enter a name for the new TV Hunt profile.</p>
            </div>
            <div class="profile-add-modal-body">
                <label for="tv-hunt-profile-add-name">Profile name</label>
                <input type="text" id="tv-hunt-profile-add-name" class="profile-add-name-input" placeholder="e.g. HD Only" maxlength="64" autocomplete="off">
            </div>
            <div class="profile-add-modal-actions">
                <button type="button" class="btn-card profile-add-modal-cancel" id="tv-hunt-profile-add-modal-cancel">Cancel</button>
                <button type="button" class="btn-card profile-add-modal-save" id="tv-hunt-profile-add-modal-save"><i class="fas fa-plus"></i> Add</button>
            </div>
        </div>
    </div>
</section>
<style>
    #tvHuntSettingsProfilesSection { width:100%; min-height:100vh; overflow-y:auto; overflow-x:hidden; }
    #tvHuntSettingsProfilesSection.active { display:block !important; }
    #tv-hunt-profile-instances-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 14px;
        margin-bottom: 20px;
    }
    #tv-hunt-profile-instances-grid .instance-card {
        padding: 12px 14px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    #tv-hunt-profile-instances-grid .instance-card-header { margin-bottom: 10px; }
    #tv-hunt-profile-instances-grid .instance-name { font-size: 0.95rem; gap: 6px; font-family: inherit; }
    #tv-hunt-profile-instances-grid .instance-name i { font-size: 0.85rem; }
    #tv-hunt-profile-instances-grid .default-badge { font-size: 0.6rem; padding: 2px 6px; font-family: inherit; }
    #tv-hunt-profile-instances-grid .instance-card-body { margin-bottom: 12px; flex: 1; min-height: 0; }
    #tv-hunt-profile-instances-grid .instance-card-footer { gap: 6px; margin-top: 0; }
    #tv-hunt-profile-instances-grid .btn-card { padding: 6px 10px; font-size: 0.8rem; }
    #tv-hunt-profile-instances-grid .add-instance-card { min-height: 100px; }
    #tv-hunt-profile-instances-grid .add-instance-card .add-icon { font-size: 1.5rem; }
    #tv-hunt-profile-instances-grid .add-instance-card .add-text { font-size: 0.85rem; }
    #tv-hunt-profile-instances-grid .instance-card-header-actions { display: flex; align-items: center; gap: 8px; margin-left: 8px; }
    #tv-hunt-profile-instances-grid .btn-clone-profile { background: transparent; border: none; color: #94a3b8; padding: 2px 4px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
    #tv-hunt-profile-instances-grid .btn-clone-profile:hover { color: #6366f1; background: rgba(99, 102, 241, 0.15); }
    #tv-hunt-profile-instances-grid .profile-card-quality-tags { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
    #tv-hunt-profile-instances-grid .profile-quality-tag { display: inline-block; padding: 2px 6px; font-size: 0.68rem; border-radius: 4px; background: rgba(71, 85, 105, 0.5); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.2); }
    #tv-hunt-profile-instances-grid .profile-quality-tag-highest { background: linear-gradient(135deg, rgba(202, 138, 4, 0.35) 0%, rgba(180, 83, 9, 0.35) 100%); color: #fcd34d; border-color: rgba(202, 138, 4, 0.5); font-weight: 600; }
    #tv-hunt-profile-instances-grid .profile-quality-tag-empty { color: #64748b; font-style: italic; font-size: 0.7rem; }
</style>
<script>
(function() {
    'use strict';
    function openTVHuntProfileAddModal() {
        var modal = document.getElementById('tv-hunt-profile-add-modal');
        var input = document.getElementById('tv-hunt-profile-add-name');
        if (modal && modal.parentNode !== document.body) document.body.appendChild(modal);
        if (modal) modal.style.display = 'flex';
        if (input) { input.value = ''; setTimeout(function() { input.focus(); }, 100); }
        document.body.classList.add('profile-add-modal-open');
    }
    function closeTVHuntProfileAddModal() {
        var modal = document.getElementById('tv-hunt-profile-add-modal');
        if (modal) modal.style.display = 'none';
        document.body.classList.remove('profile-add-modal-open');
    }
    function initTVHuntProfileAddModal() {
        var backdrop = document.getElementById('tv-hunt-profile-add-modal-backdrop');
        var closeBtn = document.getElementById('tv-hunt-profile-add-modal-close');
        var cancelBtn = document.getElementById('tv-hunt-profile-add-modal-cancel');
        var saveBtn = document.getElementById('tv-hunt-profile-add-modal-save');
        var input = document.getElementById('tv-hunt-profile-add-name');
        if (backdrop) backdrop.onclick = closeTVHuntProfileAddModal;
        if (closeBtn) closeBtn.onclick = closeTVHuntProfileAddModal;
        if (cancelBtn) cancelBtn.onclick = closeTVHuntProfileAddModal;
        if (saveBtn) {
            saveBtn.onclick = function() {
                var name = (input && input.value) ? input.value.trim() : '';
                if (!name) {
                    if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Enter a profile name.', 'error');
                    return;
                }
                saveBtn.disabled = true;
                fetch('./api/tv-hunt/profiles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name }) })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success && window.TVHuntSettingsForms && window.TVHuntSettingsForms.refreshTVHuntProfilesList)
                            window.TVHuntSettingsForms.refreshTVHuntProfilesList();
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Profile added.', 'success');
                        closeTVHuntProfileAddModal();
                    })
                    .catch(function() {
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Failed to add profile.', 'error');
                    })
                    .finally(function() { saveBtn.disabled = false; });
            };
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('tv-hunt-profile-add-modal') && document.getElementById('tv-hunt-profile-add-modal').style.display === 'flex')
                closeTVHuntProfileAddModal();
        });
    }
    function initTVHuntProfileGrid() {
        var grid = document.getElementById('tv-hunt-profile-instances-grid');
        if (!grid) return;
        grid.addEventListener('click', function(e) {
            var addCard = e.target.closest('.add-instance-card[data-app-type="tv-hunt-profile"]');
            var cloneBtn = e.target.closest('.btn-clone-profile[data-app-type="tv-hunt-profile"]');
            var editBtn = e.target.closest('.btn-card.edit[data-app-type="tv-hunt-profile"]');
            var setDefaultBtn = e.target.closest('.btn-card.set-default[data-app-type="tv-hunt-profile"]');
            var deleteBtn = e.target.closest('.btn-card.delete[data-app-type="tv-hunt-profile"]');
            if (cloneBtn) {
                e.preventDefault();
                e.stopPropagation();
                var profileId = cloneBtn.getAttribute('data-profile-id');
                if (!profileId) return;
                fetch('./api/tv-hunt/profiles/' + encodeURIComponent(profileId) + '/clone', { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success && window.TVHuntSettingsForms && window.TVHuntSettingsForms.refreshTVHuntProfilesList)
                            window.TVHuntSettingsForms.refreshTVHuntProfilesList();
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Profile duplicated.', 'success');
                    })
                    .catch(function() {
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Failed to duplicate profile.', 'error');
                    });
            } else if (editBtn) {
                e.preventDefault();
                var profileId = editBtn.getAttribute('data-profile-id');
                if (profileId && window.TVHuntSettingsForms && window.TVHuntSettingsForms.openTVHuntProfileEditor)
                    window.TVHuntSettingsForms.openTVHuntProfileEditor(profileId);
            } else if (addCard) {
                e.preventDefault();
                openTVHuntProfileAddModal();
            } else if (setDefaultBtn) {
                e.preventDefault();
                var profileId = setDefaultBtn.getAttribute('data-profile-id');
                if (!profileId) return;
                fetch('./api/tv-hunt/profiles/' + encodeURIComponent(profileId), { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_default: true }) })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.success && window.TVHuntSettingsForms && window.TVHuntSettingsForms.refreshTVHuntProfilesList)
                            window.TVHuntSettingsForms.refreshTVHuntProfilesList();
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Default profile updated.', 'success');
                    })
                    .catch(function() {
                        if (window.huntarrUI && window.huntarrUI.showNotification) window.huntarrUI.showNotification('Failed to update.', 'error');
                    });
            } else if (deleteBtn) {
                e.preventDefault();
                var profileId = deleteBtn.getAttribute('data-profile-id');
                if (!profileId) return;
                var list = window.TVHuntSettingsForms && window.TVHuntSettingsForms._tvHuntProfilesList ? window.TVHuntSettingsForms._tvHuntProfilesList : [];
                var profile = list.find(function(p) { return p.id === profileId; });
                var name = profile && profile.name ? profile.name : 'this profile';
                var doDelete = function() {
                    fetch('./api/tv-hunt/profiles/' + encodeURIComponent(profileId), { method: 'DELETE' })
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            if (data.success && window.TVHuntSettingsForms && window.TVHuntSettingsForms.refreshTVHuntProfilesList)
                                window.TVHuntSettingsForms.refreshTVHuntProfilesList();
                            if (window.huntarrUI && window.huntarrUI.showNotification)
                                window.huntarrUI.showNotification(data.success ? 'Profile deleted.' : (data.error || 'Could not delete.'), data.success ? 'success' : 'error');
                        })
                        .catch(function() {
                            if (window.huntarrUI && window.huntarrUI.showNotification)
                                window.huntarrUI.showNotification('Failed to delete profile.', 'error');
                        });
                };
                if (window.HuntarrConfirm && window.HuntarrConfirm.show) {
                    window.HuntarrConfirm.show({ title: 'Delete Profile', message: 'Delete "' + name + '"?', confirmLabel: 'Delete', onConfirm: doDelete });
                } else {
                    if (!confirm('Delete "' + name + '"?')) return;
                    doDelete();
                }
            }
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { initTVHuntProfileAddModal(); initTVHuntProfileGrid(); });
    } else {
        initTVHuntProfileAddModal();
        initTVHuntProfileGrid();
    }
})();
</script>
